
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Zero To One &#8212; miros 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Diagrams" href="reading_diagrams.html" />
    <link rel="prev" title="Quick Start" href="quickstart.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <blockquote id="zero-to-one-zero-to-one">
<div><p><em>Begin.  To Begin is half the work, let half still remain; again begin this,
and thou wilt have finished.</em></p>
<p class="attribution">&mdash;Marcus Aurelius</p>
</div></blockquote>
<div class="section" id="zero-to-one">
<h1>Zero To One<a class="headerlink" href="#zero-to-one" title="Permalink to this headline">¶</a></h1>
<p>This is not a 5 minute blog read.  If you want to learn how statecharts
work, this is your one stop shop, it will take you from 0 to 1, but it will
require you to focus and actually work through the example.</p>
<p>I’ll first try and show how a miros statecharts work, without using
technical-language.  To do this, I’ll tell you a story about some characters
interacting in a little universe.  Then I’ll show you how to make a reactive
toaster oven.</p>
<p>The story will have some pictures, which I have created using a UML drawing
tool.  The images are intended to get someone who hasn’t seen UML before,
comfortable looking at statecharts drawn this way.  These pictures will act as a
bridge between the story and how to program a statechart.  (If an image is too
small in your browser, click on it to open it as a full-sized pdf.)</p>
<p>If you find the story is confusing, don’t worry, a concrete and straightforward
statechart <a class="reference internal" href="#zero-to-one-a-simple-example"><span class="std std-ref">example</span></a> will follow it.  With each
reading, the statechart mechanics should become more clear for you.</p>
<div class="admonition-scott-volk-2018-09-09 admonition">
<p class="first admonition-title">Scott Volk: 2018-09-09</p>
<p>I will also pepper the story with boxes, like this one, containing <strong>hints</strong>
about how the story relates to the technical aspects of statecharts.</p>
<p>I challenge you <em>not to read</em> these boxes in your first look at the story,
especially if you are new to this type of technical language.  Read the hints
after you have programmed your first working statechart.</p>
<p>On your first pass just read the story and look over the pictures.</p>
<p class="last">After you have completed the example, read the story again if your
understanding of the dynamics aren’t clear.  At this point look at the hint
boxes.</p>
</div>
<div class="section" id="story">
<h2>Story<a class="headerlink" href="#story" title="Permalink to this headline">¶</a></h2>
<p>Let’s build a little universe.</p>
<p>Our universe will consist of a heaven, an earth and an underworld.   The earth
will be made up of a set of pubs, arranged on different terraces.  To get to a
higher pub, you would first have to walk through a lower pub.  The lower pubs
are for a more general audience, while the higher pubs, though having less space
have a more specialized aesthetic.</p>
<p>On every terrace, there will be two bouncers a greeter and zero or more
bartenders.   There will only be one set of stairs that can be used to enter or
exit a pub, and this is where that pub’s bouncers will be.</p>
<p>One bouncer will be facing in the direction of people entering the terrace and
the other will be facing in the direction of people wanting to leave it.  The
greeter will talk to anyone who has decided to stay on her terrace.</p>
<a class="reference external image-reference" href="_static/md_terraced_pubs.pdf"><div align="center" class="align-center"><img alt="_images/md_terraced_pubs.svg" src="_images/md_terraced_pubs.svg" /></div>
</a>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p>Each pub is a state in a statemachine.  You would program these states as
functions that take two arguments, a reference to an active object and an event.</p>
<p>These state functions will contain an if-elif structure which will have
multiple clauses.  The greeter is the “init” clause, and the enter and exit
bouncers are the “entry” and “exit” clauses.</p>
<p>The “init”, “enter”, and “exit” clauses can be activated when the state
function is given an event with an init, entry or exit name.</p>
<p class="last">Likewise, the bartender is a clause where the application developer sets the
event name.</p>
</div>
<p>The heaven will have one goddess Eve, “the goddess of law and order” and the
underworld will be ruled by Theo, “<a class="reference external" href="https://en.wikipedia.org/wiki/Solipsism">the solipsist.</a>”  The earth will have a lazy god
named Spike, “the source” who happens to be the only guy who can drink in the
whole universe.  Spike will have a companion, who is a spirit, Tara “the
explorer.”</p>
<a class="reference external image-reference" href="_static/md_terraced_gods.pdf"><div align="center" class="align-center"><img alt="_images/md_terraced_gods.svg" src="_images/md_terraced_gods.svg" /></div>
</a>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p>Eve represents the “event processor”, or the algorithm that sends the state
functions different events.</p>
<p>Spike, represents the “Source” state while the event processor is searching
the statechart.  Think of Spike as the current state of the statemachine.</p>
<p>Tara represents the “Target” state, which is used by the event processor to
explore the statemachine while it is trying to figure out what to do.</p>
<p>Theo is the “thread” in which all of the code is run.  The event processor and
all of it’s calls to the various state functions will be driven by this
thread.</p>
<p class="last">An application developer will not write code to change the internal behaviour
of the event processor, the source and target states or the thread.  This is
why these characters are supernatural in the story; it’s a mnemonic.</p>
</div>
<p>Let’s put our little universe into a small multiverse. Each universe will have
it’s own heaven and underworld, gods, people and explorer spirit, but its
terraced architecture of pubs, can be shared across all connected worlds.</p>
<a class="reference external image-reference" href="_static/md_multiverse.pdf"><div align="center" class="align-center"><img alt="_images/md_multiverse.svg" src="_images/md_multiverse.svg" /></div>
</a>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p>Anytime a statechart references a callback, that callback will change the
internal variable state of the active object in its first argument – the
state callback functions do not have their own memory.</p>
<p class="last">Since the callback functions don’t keep any information, they can be called by
many different active objects, in that active object’s thread, and behave as
expected; there are no side effects.  In this way, many different active
objects can use the same set of state callback functions.</p>
</div>
<p>Eve, the goddess of heaven has a birds-eye view of our little world.  She rules
over the people: the bouncers, greeters and bartenders and, Tara, “the explorer”
spirit.  She took on her duty as “the goddess of law and order” with such gusto,
that sometime in the world’s history, she banned alcohol consumption for
everyone on earth, except Spike, who she can’t control.</p>
<a class="reference external image-reference" href="_static/md_eve.pdf"><div align="center" class="align-center"><img alt="_images/md_eve.svg" src="_images/md_eve.svg" /></div>
</a>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p>Eve is the “event processor”.  The if-elif clauses, represented by the people
in the story, exist within each of the state functions.  These if-elif clauses
only become active when the event processor calls its function with an
internal event, represented by one of the people in the story.</p>
<p>Tara, the “target state” is used by the event processor when it is searching a
statemachine to see which state handles an external event.</p>
<p class="last">Since the event processor calls the function and change’s its target state
while it is searching through a statemachine, we say that Eve rules over the
people and Tara the “explorer spirit”.</p>
</div>
<p>Theo, “the solipsist” is the god of the underworld.  He is only called the
“solipsist” by people outside of his universe, like us, because his universe
only works and exists if he is thinking about it.  Nobody in his world is aware
that he has this power.</p>
<p>One of Theo’s duties is to join the little universe with other universes.  Theo
watches a portal, which is connected to a loading dock which receives
messages from different worlds, including ours.  He is extraordinarily attentive
and enthusiastic.  He can motivate anyone he talks to or even looks upon, in
fact, this is his supernatural ability.</p>
<a class="reference external image-reference" href="_static/md_theo.pdf"><div align="center" class="align-center"><img alt="_images/md_theo.svg" src="_images/md_theo.svg" /></div>
</a>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p class="last">Theo represents a “thread” pending on a queue.  The activeobject’s <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code>
and <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> methods allow an application developer to put events into
this queue.  When the thread sees that a queue has an item, it will wake up,
and drive the event processor, which in turn, will call the functions
making up the statemachine.</p>
</div>
<p>When Theo receives a message from another universe, it appears as a round hollow
orb which sometimes contains a scroll.  He calls these orbs “events”, and if they
have a scroll within them, he calls that scroll a “payload”.</p>
<a class="reference external image-reference" href="_static/md_events.pdf"><div align="center" class="align-center"><img alt="_images/md_events.svg" src="_images/md_events.svg" /></div>
</a>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p>An event has a name, called a signal, which can be a user defined name or it
can be a predefined name.  An event with a user defined signal name is called
an external event.  An event with a predefined name is called an internal
event.</p>
<p>The whole point of naming an event with a signal is so that a state function
can use an if-elif clause to “catch” the event when it is given to that
function.  When such an event is caught, your code is run.</p>
<p class="last">An event can have an optional payload.</p>
</div>
<p>When an “event” comes through the portal, Theo will pick it up, marvel at it
then in a reverent gesture, pass it to Eve.  They both become excited, maybe
even a little nervous, because they know there universe is going to change; it
will react to the event.</p>
<p>Theo encourages Eve to fly back up into the sky and to “follow the laws.” Then
he will watch as she gives her minions their marching orders.  Only after all of
the activity stops, will he focus his attention back on the portal.</p>
<p>Feeling oddly refreshed and encouraged by Theo, Eve looks around the map until
she see’s Spike from her high vantage point.  Spike being the god of the earth,
is easy to see and Eve knows that her underling-spirit Tara, “the explorer”,  is
always near him.</p>
<p>Eve flies done to Tara and gives her the event.  She says, “I want you to go to
the terrace where there is a bartender who knows what to do with this event.
Then I want you to go to wherever he tells you to take it.  Good luck Tara, I
believe in you.”</p>
<p>Tara enjoys Spike’s company, but she also loves adventure.</p>
<p>She looks down at the event to study it and notices that it has something written
on it, a word, a phrase, it could be different every time, but it’s a clue and
Tara loves a puzzle.  She looks around the pub on her terrace and studies each
of the bartender’s name tags.  If she sees that a name tag matches the name on
the event, she will approach that bartender and talk to him.</p>
<a class="reference external image-reference" href="_static/md_events_bartenders.pdf"><div align="center" class="align-center"><img alt="_images/md_events_bartenders.svg" src="_images/md_events_bartenders.svg" /></div>
</a>
<p>If there is no bartender to talk to on her terrace, she will go to it’s exit
staircase and descend to the next terrace.  Being a spirit, she is hard to see
and the bouncers and greeters leave her alone when she is by herself.</p>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p>The terraces are just callback functions containing if-elif-else clauses.  The
else clause of each callback function provides information about what other
callback function should be called if it doesn’t know what to do with a given
event.  This other function, can be thought of as a lower terrace.</p>
<p>The bartenders are named arrows on the HSM diagram.</p>
<p class="last">The bartender also represents an if-elif clause that matches the name of the
event given to that function.</p>
</div>
<p>She will continue to climb down the terraces until she comes to the edge of the
universe.  If she can’t find a bartender who can answer her question, she will
take the event and throw it off the edge of the earth, into oblivion, then climb
back up to rejoin Spike.  In such rare cases their universe doesn’t react to the
event.</p>
<a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_oblivion.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_oblivion.svg" src="_images/md_bartenders_on_the_hsm_oblivion.svg" /></div>
</a>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p class="last">Here we are starting to explore a statechart’s dynamics.  If your statemachine
doesn’t handle an event in any of it’s callback functions, the event will be
ignored.</p>
</div>
<p>But if Tara does find a bartender who’s name tag matches the name on the event,
she will show it to him.  He will take it and study it, sometimes he might even
take out it’s scroll.  Then he will lean across the bar and whisper the answer
into Tara’s ear.</p>
<p>Sometimes the bartender says, “give me the event I’ll handle it, don’t worry
about it anymore.”  When this happens, Tara passes over the event, then rejoins
Spike, who rejoices because he doesn’t have to do anything.  For some reason
Spike calls this a “hook”.</p>
<a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_hook.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_hook.svg" src="_images/md_bartenders_on_the_hsm_hook.svg" /></div>
</a>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p>Tara, the “target state” is used by the event processor to find which state
callback function knows how to handle a given event.  In the above picture we
see that T started in “C pub”, then the event processor recursed outward to “A
pub” at which point it found an if-elif clause in the “A pub” callback that
“handled” the event with the signal name of “Merve”.  If the application
developer placed code between the “Merve” clause and it’s return statement,
this code would be run while T is searching.</p>
<p>When a state callback function returns “handled” the event processor pulls T
back to where S is, then it stops searching.</p>
<p class="last">A state callback function can use the T state of the event processor to
perform this type of event handling.  For more details about this programming
technique, read about the <a class="reference internal" href="patterns.html#patterns-ultimate-hook"><span class="std std-ref">ultimate hook pattern.</span></a></p>
</div>
<p>Most of the time, however, the bartender will tell Tara where she has to take
the event.  If she has to continue her journey, she will wait for Spike so she can
tell him about it.</p>
<a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_reaction_1.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_reaction_1.svg" src="_images/md_bartenders_on_the_hsm_reaction_1.svg" /></div>
</a>
<p>Spike knows when Tara is waiting for him.  Though he is lazy, and drunk most of
the time, he always has something interesting to say, and this is what Tara
loves about him.  Having nothing else to do, he makes his way to the terrace
where Tara has gotten her next clue.  He knows that she will want to talk to him
about it.  As he approaches the exit, the exit bouncer puts up a hand, then
looks at a clip board to see if Spike is on the guest list, which he always is,
and then let’s Spike pass to the next lower terrace.  You really can’t stop the
god of the earth.  For every terrace that Spike needs to leave so that he can
rejoin with Tara, this futile ritual is repeated.</p>
<a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_reaction_2.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_reaction_2.svg" src="_images/md_bartenders_on_the_hsm_reaction_2.svg" /></div>
</a>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p>Tara, the “target state” is used by the event processor to recurse outward
from C1 to find a state that knows what to do with the Event, who’s signal
name is Mary.</p>
<p>The A state has an if-elif clause which handles Mary, and within the clause
there is a transition to the B2 state.  In this scenario, the A state is
called the Least Common Ancestor, LCA of S and T.  S needs to exit all states,
from it’s current state, to the LCA.  However, it should not exit the LCA.</p>
<p class="last">As an application developer, you don’t really care about the LCA acronym.  You
just need to understand the dynamics of how exits work.</p>
</div>
<p>When Spike finally finds Tara he asks her what she learned.  Bubbling with
excitement, she tells him about where the bartender said to take the event, to
which he always says, “great I’ll meet you there, but first I want to have a
drink.”  Tara takes the event and makes her way to the location that the
bartender told her about.</p>
<p>Spike finishes his drink, then again starts to make his way toward Tara.  Before
he can climb up to a new Terrace, he is stopped by the entry bouncer, who looks
at his clip board to see if Spike is on the guest list, which he always is, then
let’s Spike proceed.  You really can’t stop the god of the earth anyway.</p>
<a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_reaction_3.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_reaction_3.svg" src="_images/md_bartenders_on_the_hsm_reaction_3.svg" /></div>
</a>
<p>When Spike finally arrives on the Terrace where Tara is, a greeter approaches
them.  She looks at Spike and feels slightly uncomfortable, because sometimes
she needs to tell them that they can’t stay on this terrace.  Instead of talking
to Spike directly, gods are intimidating, she whisper’s something into Tara’s
ear.  Both the greeter and Tara work for Eve after all.  Tara is always happy to
hear that there is more to do, because she likes to explore the pubs on the
different terraces.</p>
<p>If the greeter tells Tara that she needs to climb higher, Tara will relay the
message to Spike who will answer, “great, I’ll meet you there, but first I want
to have a drink”.</p>
<p>Tara climbs to the terrace where the greeter told her to go.  Spike finishes his
drink and makes his way through the entry bouncers and finally arrives at the
same terrace where Tara is waiting.  At which point there might be another
greeter with another uncomfortable message.</p>
<a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_reaction_4.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_reaction_4.svg" src="_images/md_bartenders_on_the_hsm_reaction_4.svg" /></div>
</a>
<p>If no greeter approaches them, Tara looks down at the event and watches with
satisfaction, as it throbs with light, then slowly fades from existence.  To
this, Spike smiles and looks towards heaven, as he raises a toast to Eve.</p>
<p>When Eve, the goddess of heaven, see’s this her shoulder’s relax and the tension
releases from her back: The laws were followed.</p>
<p>Theo, “the solipsist”, god of the underworld, has been watching the whole scene,
and its “run to completion”.  Knowing there is nothing left to do in the
universe, he turns his gaze back to the portal.  He waits patiently for an event
to pass through the little universe’s loading dock.  All is well.</p>
<div class="admonition-hint admonition">
<p class="first admonition-title">hint</p>
<p>The run to completion, RTC, concept is very important to understand.  Your
statechart will only react to one event at a time.  The thread will only
process the next event when the event processor has run out of things to do
with your old event.</p>
<p class="last">For this reason, you should not put blocking code into your statecharts.  If
you do, they will stop reacting to events and become unresponsive.</p>
</div>
<p>But is it?  Sometimes when Theo, “the solipsist”, god of the underworld, closes
his eyes and daydreams; his attention briefly drifts back to his world.  This is
enough to wake everyone up from their non-existence.</p>
<p>When the people wake up, they become listless. The bouncers who have had nothing
to do since the prohibition was announced by Eve, are particularly frustrated
with the meaninglessness of their jobs.  They only have one customer now.  Even
if Spike wasn’t always permitted to pass them, there is no way they could stop
the god of earth. Why have a universe full of pubs if only one guy can drink?
It seems so pointless.</p>
<p>Then somehow they find out about you and me, fellow humans called developers.</p>
<p>They learn that we, despite being human, are all powerful.  That we can build
the pub terrace system to which their gods are subservient; that we can send the
events and give the greeters and the bouncers their secret directions (arrows on
the diagram).  That we can even built lots of different interconnected universes
and have them communicate with each other.</p>
<p>They challenge us to make something useful out of their existence, even if they
can’t understand it from where they are, they need something to <em>mean
something</em>.  So, they create an organized campaign: “hack the humans”.  This is
how it works: All of the humans in the little universe, open themselves to run
code from our universe, while they are talking to either Tara or Spike.</p>
<a class="reference external image-reference" href="_static/md_hack_the_humans.pdf"><div align="center" class="align-center"><img alt="_images/md_hack_the_humans.svg" src="_images/md_hack_the_humans.svg" /></div>
</a>
<p>To help us, they create a Rosetta stone, translating the concepts of their
universe into something legible for you and me:</p>
<table border="1" class="docutils">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Story Concept</strong></th>
<th class="head"><strong>Programming Concept</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>The universe</td>
<td>a statechart, which is an ActiveObject
derived object.</td>
</tr>
<tr class="row-odd"><td>The multiverse of terraced bars</td>
<td>a set of callback functions making an
HSM (accessible from multiple
statecharts, via the <code class="docutils literal notranslate"><span class="pre">start_at</span></code>
method), each callback takes two
arguments, a reference to a statechart
and an event to send to it</td>
</tr>
<tr class="row-even"><td>Eve, “the goddess of law and order”,
goddess of heaven</td>
<td>the event processor</td>
</tr>
<tr class="row-odd"><td>Spike, “the source”,
god of the earth</td>
<td>the source state, <strong>S</strong> of a statechart
(the current state of the HSM)</td>
</tr>
<tr class="row-even"><td>Theo, “the solipsist”
god of the underworld</td>
<td>the thread that drives the
statechart</td>
</tr>
<tr class="row-odd"><td>Tara, “the explorer”, spirit</td>
<td>a search aspect, <strong>T</strong>, of the
event processor</td>
</tr>
<tr class="row-even"><td>bartender</td>
<td>arrow or hook on the HSM diagram,
represented as a conditional statement
for a user defined event,
any code associated with this
conditional statement it run when
touched by <strong>T</strong></td>
</tr>
<tr class="row-odd"><td>greeter</td>
<td><code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> event given to callback
by the event processor when <strong>S</strong>
stabilizes in the state it represents</td>
</tr>
<tr class="row-even"><td>exit bouncer</td>
<td><code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code> event given to callback
by the event processor when <strong>S</strong> exits
the state it represents</td>
</tr>
<tr class="row-odd"><td>exit bouncer</td>
<td><code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code> event given to callback
by the event processor when <strong>S</strong> enters
the state it represents</td>
</tr>
<tr class="row-even"><td><strong>run to completion, RTC</strong>:
Theo keeps his attention on the
universe’s activities until the
action stops</td>
<td>The thread will only handle one event
a time. This is called RTC.  An RTC
process is over when the event processor
can no longer cause state transitions
and the statechart settles on a new
state.</td>
</tr>
<tr class="row-odd"><td>Top level view of terraced bar
universe</td>
<td>Make these drawings with a 90’s drawing
technology called UML</td>
</tr>
</tbody>
</table>
<p>Here is a warning that they provide us about UML:</p>
<a class="reference external image-reference" href="_static/md_translation_with_notes.pdf"><div align="center" class="align-center"><img alt="_images/md_translation_with_notes.svg" src="_images/md_translation_with_notes.svg" /></div>
</a>
<p>The above diagram shows us how a lot of information is missing from a “UML
statechart”.  The picture describes some class information, and a behavioural
specification for the states provided as a bird’s eye view of the terraced bar
system, but there is no information about the thread, <strong>S</strong>, <strong>T</strong>, the deques,
the events or any of the dynamics for the statechart.</p>
<p>So the human’s provide us with the option of laying down a spy-carpet over any
bar in their universe. If you lay this carpet down, it will record and report
all activity that transpired between <strong>T</strong>, <strong>S</strong> and any human within that pub.
To use this carpet, you place the <strong>spy_on</strong> decorator above any callback
function representing a pub, or state in the HSM.  This is called
instrumentation.</p>
<p>Let’s answer their challenge for deep meaning, by using one of their universes
to make a toaster oven:</p>
</div>
<div class="section" id="a-simple-example-toaster-oven">
<span id="zero-to-one-a-simple-example"></span><h2>A Simple Example: Toaster Oven<a class="headerlink" href="#a-simple-example-toaster-oven" title="Permalink to this headline">¶</a></h2>
<p>To make this toaster oven statechart example seem like a real software project,
I will break it’s design process up into 6 steps, or iterations.</p>
<p>Each iteration will have a specification, a design diagram and the code needed
to match the design diagram.  Then I will prove that the code works and I’ll
provide links to a bunch of questions and answers about the code.</p>
<p>You can use these links to choose the questions you want to see the answers to,
or just skip onto the next iteration.</p>
<p>Each iteration will be heavily linked so that you can quickly bounce around in
its documentation.</p>
<hr class="docutils" />
<div class="section" id="iteration-1-setup">
<h3>Iteration 1: setup<a class="headerlink" href="#iteration-1-setup" title="Permalink to this headline">¶</a></h3>
<p>In this iteration I will talk about setting up our development environment.  We
will built a very simple statechart example and confirm that it is working.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="iter1-spec">Iteration 1 specification:</p>
<ul class="simple">
<li>Ensure our Python version is 3.5 or greater (miros needs this to work)</li>
<li>Install miros</li>
<li>Import the required statechart components</li>
<li>Build a ToasterOven class which inherits from an ActiveObject</li>
<li>Make a single state, and start the statechart in that state</li>
<li>Add instrumentation to our state</li>
<li>Use the instrumentation to confirm that the statechart is working.</li>
</ul>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p>To confirm that Python is version 3.5 or greater, in your terminal type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 --version
</pre></div>
</div>
<p>To install miros, use pip (included in Python 3.5 or greater), in your terminal
type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 -m venv
. ./venv/bin/activate
pip install miros
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Miros is not dependent on any other packages.</p>
</div>
<p id="iter1-design">Here is the design we will use to confirm that miros is working on your computer:</p>
<a class="reference external image-reference" href="_static/ToasterOven_0.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0.svg" src="_images/ToasterOven_0.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="iter1-code">Here is the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># file named toaster_oven_1.py</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">some_state_to_prove_this_works</span><span class="p">)</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="iter1-proof">Now to prove that the code works, in your terminal, run the program:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 toaster_oven_1.py
hello world
<span class="o">[</span><span class="m">2018</span>-09-11 <span class="m">09</span>:35:10.011526<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> <span class="se">\</span>
  e-&gt;start_at<span class="o">()</span> top-&gt;some_state_to_prove_this_works
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="iter1-questions">Questions and Answers about the code and the results:</p>
<ul class="simple">
<li><a class="reference internal" href="#why-is-miros-onl"><span class="std std-ref">Why is miros only supported in Python 3.5 or greater?</span></a></li>
<li><a class="reference internal" href="#can-you-explain"><span class="std std-ref">Can you explain what is going on with the imports on lines 1-6?</span></a></li>
<li><a class="reference internal" href="#why-bother-making"><span class="std std-ref">Why bother making a ToasterOven that inherits from the ActiveObect, why not just use the ActiveObject?</span></a></li>
<li><a class="reference internal" href="#you-keep-calling"><span class="std std-ref">You keep calling the state functions callbacks, what do you mean by this?</span></a></li>
<li><a class="reference internal" href="#what-do-you-mean"><span class="std std-ref">What do you mean by a function signature?</span></a></li>
<li><a class="reference internal" href="#how-am-i-going-t"><span class="std std-ref">How am I going to remember to structure my callback functions with all of these rules?</span></a></li>
<li><a class="reference internal" href="#this-seems-stran"><span class="std std-ref">This seems strange to me, I haven’t seen Python that looks like this before.  Why do it this way?</span></a></li>
<li><a class="reference internal" href="#where-is-the-thr"><span class="std std-ref">Where is the thread, event processor and queues in the diagram?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-what-is-happening-in-the-entry-clau"><span class="std std-ref">Can you explain what is happening in the entry clause?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-where-the-init-and-exit-clauses-a"><span class="std std-ref">Can you explain where the init and exit clauses are?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-what-is-going-on-with-the-else-clau"><span class="std std-ref">Can you explain what is going on with the else clause?</span></a></li>
<li><a class="reference internal" href="#how-does-the-live-trace-call-wo"><span class="std std-ref">How does the live_trace call work?</span></a></li>
<li><a class="reference internal" href="#what-happens-when-the-start-at-method-is-call"><span class="std std-ref">What happens when the start_at method is called?</span></a></li>
<li><a class="reference internal" href="#why-are-you-placing-a-delay-at-the-end-of-the-code-samp"><span class="std std-ref">Why are you placing a delay at the end of the code sample?</span></a></li>
<li><a class="reference internal" href="#how-did-your-prove-that-your-code-work"><span class="std std-ref">How did your prove that your code worked?</span></a></li>
<li><a class="reference internal" href="#why-are-you-using-threads"><span class="std std-ref">Why are you using threads and not asyncio?</span></a></li>
<li><a class="reference internal" href="#when-is-it-going-to-be-do"><span class="std std-ref">When is it going to be done?</span></a></li>
</ul>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-is-miros-onl"><strong>Why is miros only supported in Python 3.5 or greater?</strong></p>
<p>I originally wrote and tested miros in Python 3.5.  I didn’t know it at the
time, but I used the Python 3.5 feature of avoiding circular imports.  When I
tried to run miros in 3.4 I got a lot of ImportErrors.  So there you go, it was
an accidental limitation.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain"><strong>Can you explain what is going on with the imports on lines 1-6?</strong></p>
<p>I’ll answer this question by putting a lot of comments into the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ActiveObject contains the thread, event processor, and queues</span>
<span class="c1"># it also contains the miros API</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>

<span class="c1"># return_status contains information on how a state callback</span>
<span class="c1"># should respond when called by the event processor</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="c1"># Event is the miros Event class, use this to make a new event object</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>

<span class="c1"># signals, contains all of the signal names in the system</span>
<span class="c1"># it also automatically constructs new signals names if it</span>
<span class="c1"># is used with a name that hasn&#39;t been used before:</span>
<span class="c1">#   example:</span>
<span class="c1">#     e = Event(signal=signals.NEW_NAME)</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>

<span class="c1"># spy_on is a decorator which when applied to state callback</span>
<span class="c1"># function will let use used the spy and trace instrumentation</span>
<span class="c1"># on that callback</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>

<span class="c1"># time is imported so that the program can be delayed</span>
<span class="kn">import</span> <span class="nn">time</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-bother-making"><strong>Why bother making a ToasterOven that inherits from the ActiveObect, why not just use the ActiveObject?</strong></p>
<p>We will put toaster oven attributes and worker functions into the toaster oven
class later.  For instance, we could put a <code class="docutils literal notranslate"><span class="pre">light_on</span></code> method in the
ToasterOven class.  The first argument given to any state callback function by
the event processor will be a reference to a ToasterOven object. Now suppose
this first argument was called <code class="docutils literal notranslate"><span class="pre">oven</span></code>, any state callback function could turn
on the light with: <code class="docutils literal notranslate"><span class="pre">oven.light_on()</span></code></p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="you-keep-calling"><strong>You keep calling the state functions callbacks, what do you mean by this?</strong></p>
<p>A callback function is just a function that is given to another function, so
that it can be called later:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># this will be our callback</span>
<span class="k">def</span> <span class="nf">print_msg</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">call_something_later</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">callback</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>

<span class="c1"># wait one second then print &quot;hello world&quot;</span>
<span class="n">call_something_later</span><span class="p">(</span><span class="n">print_msg</span><span class="p">)</span>
</pre></div>
</div>
<p>The states in our diagram are constructed as callback functions with a given
signature.  The event processor will call these functions when it needs to.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="what-do-you-mean"><strong>What do you mean by a function signature?</strong></p>
<p>A function signature describes the arguments that a function can take and the
type of items it can return.</p>
<p>Our state callback functions will always have the same signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The event processor will call this function when it needs to</span>
<span class="c1"># because the  function isn&#39;t called right away,</span>
<span class="c1"># it is called a callback function</span>

<span class="c1"># 1st part of the function signature, it&#39;s arguments.</span>
<span class="c1"># Our state callback functions will always take two arguments:</span>
<span class="c1"># 1) a reference to a state_chart_object</span>
<span class="c1"># 2) an event</span>
<span class="k">def</span> <span class="nf">some_state_function</span><span class="p">(</span><span class="n">state_chart_object</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># do useful work, then</span>

  <span class="c1"># set the status variable to an attribute of return_status</span>
  <span class="c1"># to tell the event processor how your function responded</span>
  <span class="c1"># to its call</span>

  <span class="c1"># 2nd part of the function signature: it will always return</span>
  <span class="c1"># an attribute of the return_status object</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>For a real state function, it’s signature would be expressed like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span>  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</td></tr></table></div>
<p>To make our state callback function have the right signature, we ensure that it
takes two arguments, a statechart object and an event, line 1.  Then, depending
on how the function reacts, we either return:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">return_status.UNHANDLED</span></code> if we want an event to bubble outward in the
chart.  Typically this is the default value of the item you will return from
a statechart callback.  See line 2.</li>
<li><code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code> when we want the event processor to stop searching
for an event.  See line 3.</li>
<li><code class="docutils literal notranslate"><span class="pre">return_status.SUPER</span></code> when we don’t know what to do to the event, so we
return information that will tell the event processor to try our super state. See line 8.</li>
</ul>
</div></blockquote>
<p>There are more things that can be returned, we will address them as the example continues.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="this-seems-stran"><strong>This seems strange to me, I haven’t seen Python that looks like this before.  Why do it this way?</strong></p>
<p>The miros library is intended to serve two different audiences:</p>
<ul class="simple">
<li>Embedded programmers who need to quickly prototype their designs, then port
the work to c/C++ using the QP framework.</li>
<li>Python developers who want to use statecharts.</li>
</ul>
<p>This way of writing statecharts – by using callbacks with if-elif structures,
working with an ActiveObject – will make code that is extremely easy to port
back to the QP framework.</p>
<p>If you would like to program in a more “Pythonic” way, you can inherit from the
miros Factory class instead of the ActiveObject.  Under the hood, the Factory
class is just making the kinds of callback functions we are talking about here.</p>
<p>It is easier to explain this library using the traditional techniques of engaging
with the Miros Samek event processing algorithm than by just jumping into the
Factory class.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-am-i-going-t"><strong>How am I going to remember to structure my callback functions with all of these rules?</strong></p>
<p>Once you do it a few times you will remember it.  To begin with just reference
the <a class="reference internal" href="recipes.html#recipes-boiler-plate-state-method-code"><span class="std std-ref">boiler plate example</span></a>, and change it
to match your design.</p>
<p>Also, it is relatively easy to add this boiler plate code to whatever snippet
technology you are using with your editor. I use Ultisnips in Vim.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="where-is-the-thr"><strong>Where is the thread, event processor and queues in the diagram?</strong></p>
<p>The thread is missing from the UML:</p>
<a class="reference external image-reference" href="_static/ToastOven_0_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0_1.svg" src="_images/ToasterOven_0_1.svg" /></div>
</a>
<p>Unlike the thread the event processor is shown on the picture, though this is
probably invalid UML:</p>
<a class="reference external image-reference" href="_static/ToastOven_0_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0_2.svg" src="_images/ToasterOven_0_2.svg" /></div>
</a>
<p>I leave the event processor on my pictures so I can show the starting state of
the active object.</p>
<p>The queues are missing from the UML as well:</p>
<a class="reference external image-reference" href="_static/ToastOven_0_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0_3.svg" src="_images/ToasterOven_0_3.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-what-the-spy-on-decorator-is-doing"><strong>Can you explain what the spy_on decorator is doing?</strong></p>
<p>The spy_on decorator wraps a state’s callback function with some code that lets
you log the output of the event processor as it follows its rules, making <strong>T</strong>
and <strong>S</strong> move around the HSM.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
</span>
<span class="hll"><span class="nd">@spy_on</span>
</span><span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>By using the decorator you can debug, test and document the behavior of your
statechart.</p>
<p>If you don’t include the decorator, the statechart will work a little bit
faster, but it will be harder to debug.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The spy_on decorator needs to be placed on every callback that you want to
monitor.  I usually place the spy_on decorator on all of the state callbacks.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-what-is-happening-in-the-entry-clau"><strong>Can you explain what is happening in the entry clause?</strong></p>
<p>When the event processor sends an event with the signal name <code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code>
the if clause of the state callback will print “hello world” to the terminal
then it will set the status variable to <code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code>.  This status value
is returned to the event processor, letting it know to stop processing the
<code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code> event.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The entry signal is sent to the callback as a result of the HSM being started in
the <code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code> state.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-where-the-init-and-exit-clauses-a"><strong>Can you explain where the init and exit clauses are?</strong></p>
<p>We don’t need the init and exit clauses in the design, so we don’t include them
in the if-elif structure of the state’s callback function.  The event processor
will still call the function with the event named <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code>, after it has
entered the <code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code> state, but it will be ignored.</p>
<p>By only including the events that we need we keep our callback function small
and easy to read.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-what-is-going-on-with-the-else-clau"><strong>Can you explain what is going on with the else clause?</strong></p>
<p>The else clause is used by <strong>T</strong> to know how to search outward in a statechart.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>  <span class="c1"># no outer state</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The callback functions report where they are in the HSM’s hierarchy by setting
the <code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> of their active object.  They set this value to point to their
super state, or the state that is outside their current state in the diagram.</p>
<p>In this case, the <code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code> state doesn’t have an outer
state, so we set the <code class="docutils literal notranslate"><span class="pre">oven.temp.fun</span></code> attribute to <code class="docutils literal notranslate"><span class="pre">oven.top</span></code>, to let the event
processor know it has reached the outermost state of the HSM.</p>
<a class="reference external image-reference" href="_static/ToastOven_0_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0_4.svg" src="_images/ToasterOven_0_4.svg" /></div>
</a>
<p>The returned value of the state callback function is set to
<code class="docutils literal notranslate"><span class="pre">return_status.SUPER</span></code> so that your function can notify the event processor
that it set the <code class="docutils literal notranslate"><span class="pre">oven.temp.fun</span></code> to its superstate’s function.</p>
<p>There are many different reasons the event processor might want to trigger the
else clause in your callback function.  It could call the state callback with a
reserved event, which it knows will not be in the if-elif structure – it does
this when it is trying to discover the hierarchy of your HSM.  It could also use
the else clause to make <strong>T</strong> bubble out of the current state, when that state
doesn’t know what to do with a user defined event.  This is the power of an HSM.</p>
<p>More will be said about this in the up coming iterations.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>How the else clause is called doesn’t really matter to you as an application
developer.  You just have to follow some rules:</p>
<ul class="last simple">
<li>set the <code class="docutils literal notranslate"><span class="pre">oven.temp.fun</span></code> to the callback function representing the
superstate</li>
<li>if there is no superstate, set it to the <code class="docutils literal notranslate"><span class="pre">top</span></code> attribute of the first
argument given to the callback</li>
<li>ensure that the callback function returns, return_state.SUPER if the else
clause is reached.</li>
</ul>
</div>
<span class="target" id="how-does-the-live-trace-call-wo"></span><a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p><strong>How does the live_trace call work?</strong></p>
<p>The <a class="reference internal" href="recipes.html#recipes-tracing-live"><span class="std std-ref">live_trace</span></a> attribute needs to be set before the
statechart’s thread is started:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">some_state_to_prove_this_works</span><span class="p">)</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>It output’s the trace log as your statechart is reacting to events.  It can only
work if the spy_on decorator is placed above the state functions in your HSM.</p>
<p>There are two different types of instrumentation output provided by miros.  The
<a class="reference internal" href="recipes.html#recipes-using-the-trace"><span class="std std-ref">trace</span></a> and the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a>.  The trace provides information only if a state
transition has occurred.  It reports is <strong>S</strong> has moved.  For each line in a
trace log,  describes:</p>
<blockquote>
<div><ul class="simple">
<li>The time stamp of when the event was reacted to</li>
<li>The name of the statechart</li>
<li>The event that caused the transition</li>
<li>The starting state of <strong>S</strong></li>
<li>The ending state of <strong>S</strong></li>
</ul>
</div></blockquote>
<p>Our minimal example doesn’t do much, it starts from outside of the HSM and then
transitions into the <code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">some_state_to_prove_this_works</span>
</pre></div>
</div>
<p>In this example we see: when I ran the test.  That the statechart is called oven,
that the starting state of <strong>S</strong> in this oven instance was <code class="docutils literal notranslate"><span class="pre">top</span></code> and the
ending state of <strong>S</strong> was <code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code>.</p>
<p>There is no <code class="docutils literal notranslate"><span class="pre">start_at</span></code> event in miros.  But to keep the trace output useful
for the person looking at it, I pretend that at a <code class="docutils literal notranslate"><span class="pre">start_at</span></code> event causes the
initial transition into the HSM.  On the diagram, this will be where the event
processor attachment point touches the HSM.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I might remove some information from the timestamp in this documenation to make
the text fit on the screen.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="what-happens-when-the-start-at-method-is-call"><strong>What happens when the start_at method is called?</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">start_at</span></code> method links the oven object to the HSM, then it starts the
statechart.  It does this by creating a new thread, then running the oven’s
event processor in that thread.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">some_state_to_prove_this_works</span><span class="p">)</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>Before a statechart is started, <strong>T</strong> and <strong>S</strong> exist outside of the outermost
state.  The <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call, places <strong>T</strong> into the
<code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code>.  <strong>S</strong> marches towards <strong>T</strong> triggering as
many needed entry events as required, then the init event in the state that
<strong>T</strong> is in.</p>
<p>In our example there isn’t much to talk about.  The entry clause of the
<code class="docutils literal notranslate"><span class="pre">some_state_function</span></code> is called, printing “hello world”.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-are-you-placing-a-delay-at-the-end-of-the-code-samp"><strong>Why are you placing a delay at the end of the code sample?</strong></p>
<p>When you call the start_at method of the oven statechart, it starts a new
thread. Then it runs the oven’s event processor in that thread.  The main
program runs in the main thread.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">some_state_to_prove_this_works</span><span class="p">)</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>The delay is placed at the bottom of the file to ensure that the statechart’s
thread can react, and produce some live trace feedback, before the main thread
exits the program.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The miros package uses daemonic threads, which means that they will be shut
down with the main thread stops running.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-did-your-prove-that-your-code-work"><strong>How did your prove that your code worked?</strong>
Looking at the design, we see that the starting state should be
<code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code> and that when it enters this state it should
print “hello world” to the terminal.</p>
<a class="reference external image-reference" href="_static/ToasterOven_0.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0.svg" src="_images/ToasterOven_0.svg" /></div>
</a>
<p>The output is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>hello world
<span class="o">[</span><span class="m">2018</span>-09-11 <span class="m">09</span>:35:10.011526<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> <span class="se">\</span>
  e-&gt;start_at<span class="o">()</span> top-&gt;some_state_to_prove_this_works
</pre></div>
</div>
<p>Which is exactly what were were expecting.</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-are-you-using-threads"><strong>Why are you using threads and not asyncio?</strong></p>
<p>Asyncio is cool, but it doesn’t work with everything yet.  It may be the future
of Python, but to use it all of your libraries will have to be asyncio
compliant.  I wrote miros so that it can use as much existing Python as possible.</p>
<p>If you want to check out another implementation of the Miro Samek event
processing algorithm in Python, written with asyncio, check out <a class="reference external" href="https://github.com/dwhall/pq">Dean Hall’s pq.</a></p>
<p id="when-is-it-going-to-be-do"><strong>When is it going to be done?</strong></p>
<p>I’m not answering this question</p>
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-2-basic-oven">
<span id="iter2"></span><h3>Iteration 2: basic oven<a class="headerlink" href="#iteration-2-basic-oven" title="Permalink to this headline">¶</a></h3>
<p>Now that we know miros will run on our system, lets use it to build a very basic
toaster oven.</p>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="iter2-spec">Iteration 2 specification:</p>
<ul class="simple">
<li>The toaster oven will have a door, it will always be closed</li>
<li>The toaster oven will have an oven light, which can be turned off and on</li>
<li>The toaster oven will have a heater, which can be turned off and on</li>
<li>It will have two different heating modes, baking which can bake a potato
and toasting which can toast some bread.</li>
<li>The toaster oven should start in the off state</li>
<li>The toaster can only heat when the door is closed.</li>
<li>The toaster’s light should be off when the door is closed.</li>
</ul>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<a class="reference external image-reference" href="_static/ToasterOven_2.pdf" id="iter2-design"><div align="center" class="align-center"><img alt="_images/ToasterOven_2.svg" src="_images/ToasterOven_2.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<div class="highlight-python notranslate" id="iter2-code"><div class="highlight"><pre><span></span><span class="c1"># file named toaster_oven_2.py</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">light_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;light_on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">light_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;light_on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;heater_on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;heater_off&quot;</span><span class="p">)</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">baking</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;baking&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">toasting</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;toasting&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="c1"># toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># turn the oven off</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<div class="highlight-bash notranslate" id="iter2-proof"><div class="highlight"><pre><span></span>python3 toaster_oven_2.py
off
<span class="o">[</span><span class="m">2018</span>-09-12 <span class="m">13</span>:54:51.890583<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> e-&gt;start_at<span class="o">()</span> top-&gt;off
heater_on
toasting
<span class="o">[</span><span class="m">2018</span>-09-12 <span class="m">13</span>:54:51.891473<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> e-&gt;Toasting<span class="o">()</span> off-&gt;toasting
heater_off
heater_on
baking
<span class="o">[</span><span class="m">2018</span>-09-12 <span class="m">13</span>:54:51.891989<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> e-&gt;Baking<span class="o">()</span> toasting-&gt;baking
heater_off
off
<span class="o">[</span><span class="m">2018</span>-09-12 <span class="m">13</span>:54:51.892568<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> e-&gt;Off<span class="o">()</span> baking-&gt;off
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="iter2-questions">Questions and Answers about code and results (iteration 2):</p>
<ul class="simple">
<li><a class="reference internal" href="#can-you-explain-how-the-picture-meets-the-design-specification"><span class="std std-ref">Can you explain how the picture meets the design specification?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-the-callbacks-are-arranged-relative-to-each-other"><span class="std std-ref">How do I write my state callback functions based on the HSM diagram?</span></a></li>
<li><a class="reference internal" href="#how-do-i-use-the-return-status-with-the-callbacks"><span class="std std-ref">How do I use the return_status with these callbacks?</span></a></li>
<li><a class="reference internal" href="#how-does-this-toaster-oven-example-relate-to-humans-in-the-story"><span class="std std-ref">How does this toaster oven example relate to humans in the story?</span></a></li>
<li><a class="reference internal" href="#what-does-posting-the-events-do"><span class="std std-ref">What does posting the events do?</span></a></li>
<li><a class="reference internal" href="#where-are-the-signal-names-defined"><span class="std std-ref">Where are the event names defined?</span></a></li>
<li><a class="reference internal" href="#what-are-s-and-t-exactly-why-not-just-talk-about-s"><span class="std std-ref">What are S and T exactly? Why no just talk about S?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-this-statechart-starts"><span class="std std-ref">Can you explain how this statechart starts?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-this-statechart-toasts"><span class="std std-ref">Can you explain how this statechart can transition from off to toasting?</span></a></li>
<li><a class="reference internal" href="#is-there-a-way-i-can-get-miros-to-show-me-what-happened-and-how-it-happened"><span class="std std-ref">Is there a way I can get miros to show me what happened and how it happened?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-this-statechart-bakes"><span class="std std-ref">Can you explain how this statechart bakes?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-this-statechart-turns-off"><span class="std std-ref">Can you explain how this statechart turns off?</span></a></li>
<li><a class="reference internal" href="#why-are-you-putting-state-into-the-toasteroven-and-not-its-hsm"><span class="std std-ref">Why are you putting state information into the ToasterOven and not its HSM?</span></a></li>
</ul>
<p id="can-you-explain-how-the-picture-meets-the-design-specification"><strong>Can you explain how the picture meets the design specification?</strong></p>
<p>Let’s break it down:</p>
<p><strong>The toaster oven will have a door, it will always be closed</strong></p>
<p>The door_closed state will contain all of the behavior that the system will have
while the door is closed in the toaster oven.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_1.svg" src="_images/ToasterOven_2_spec_1.svg" /></div>
</a>
<p>All of the statemachine’s states exist within this door_closed state, and the
machine is started in the off state.  So the door will always be closed.</p>
<p><strong>The toaster oven will have an oven light, which can be turned off and on</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">light_on</span></code> and <code class="docutils literal notranslate"><span class="pre">light_off</span></code> methods are within the ToasterOven class which is
inherited from the ActiveObject class.  The statemachine can access these
methods at anytime.  We see that when the door_closed state is entered, it uses
one of them to shut off the oven light.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_2.svg" src="_images/ToasterOven_2_spec_2.svg" /></div>
</a>
<p><strong>The toaster oven will have a heater, which can be turned off and on</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">heater_on</span></code> and <code class="docutils literal notranslate"><span class="pre">heater_off</span></code> methods are within the ToasterOven class
which is inherited from the ActiveObject class.  The statemachine can access
these methods at anytime.  We see that when the heating state is entered, it
uses one of them to turn on the heater, and when it is exited, it uses the other
one to turn off the heater.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_3.svg" src="_images/ToasterOven_2_spec_3.svg" /></div>
</a>
<p><strong>It will have two different heating modes, baking which can bake a potato and toasting which can toast some bread</strong></p>
<p>The toasting and baking states exist within the heating state.  To get to the
states we need to invent two different events, named, “Baking” and “Toasting”.
To allow our statechart to respond to these events, two different arrows are
drawn from the door_closed state into the baking and toasting states.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_4_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_4_1.svg" src="_images/ToasterOven_2_spec_4_1.svg" /></div>
</a>
<p>What these arrows mean in English is, “while I’m in any state within the
door_closed state, a “Baking” event will cause me to enter the baking state, and a
“Toasting” event will cause me to enter the toasting state.</p>
<p>If you haven’t seen an HSM before, placing the arrows from the outer state
pointing to an inner state, is the equivalent of drawing these arrows from all
of the states within the outer state to the target inner state.  That last
sentence is hard to parse; its idea is best explained with a picture:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_4_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_4_2.svg" src="_images/ToasterOven_2_spec_4_2.svg" /></div>
</a>
<p>So now we have two different heating modes, but do they behave differently?  No,
they pretty much do the same thing, they are just called different names.</p>
<p>We will add different behaviors to these states in one of the next iterations of
the design.</p>
<p><strong>The toaster oven should start in the off state</strong></p>
<p>Before the HSM can start reacting to events, a starting state needs to be
selected.  Here we see we start in the off state, and this meets the
specification.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_5.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_5.svg" src="_images/ToasterOven_2_spec_5.svg" /></div>
</a>
<p>You can see while the unit is off, it is not heating.</p>
<p><strong>The toaster can only heat when the door is closed</strong></p>
<p>You can see how we meet this specification item in the picture:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_6.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_6.svg" src="_images/ToasterOven_2_spec_6.svg" /></div>
</a>
<p><strong>The toaster’s light should be off when the door is closed</strong></p>
<p>We can see that we have met this specification because the oven light is turned
off as the HSM transitions into the off state:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_7.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_7.svg" src="_images/ToasterOven_2_spec_7.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-the-callbacks-are-arranged-relative-to-each-other"><strong>How do I write my state callback functions based on the HSM diagram?</strong></p>
<p>Consider the HSM part of the statechart:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_0.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_0.svg" src="_images/ToasterOven_2_0.svg" /></div>
</a>
<p>Now lets make a side projection of the HSM (the side projection is not UML):</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_1.svg" src="_images/ToasterOven_2_1.svg" /></div>
</a>
<p>Here is how you would construct the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> state callback:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_2_door_closed.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_2_door_closed.svg" src="_images/ToasterOven_2_2_door_closed.svg" /></div>
</a>
<p>The callback’s if-elif clauses handle the events that interact with the state.
You can see what these events are, by doing the following:</p>
<ul class="simple">
<li>Trace your eyes around the state boundary, and identify all the arrows that
start from this boundary.</li>
<li>Identify all, hooks, entry, exit and init event handlers drawn within the
state’s region.</li>
</ul>
<p>To build your else clause:</p>
<ul class="simple">
<li>set the oven.temp.fun to the callback function representing the superstate</li>
<li>if there is no superstate, set it to the <code class="docutils literal notranslate"><span class="pre">top</span></code> attribute of the first argument given to the callback</li>
<li>ensure that the callback function returns, return_state.SUPER if the else clause is reached.</li>
</ul>
<p>Now let’s see how we would construct the off state callback:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_2_off.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_2_off.svg" src="_images/ToasterOven_2_2_off.svg" /></div>
</a>
<p>The same rules apply to the other states in the HSM.</p>
<p>So, you can think of the callback functions as actually existing in two
dimensions as a type of DAG:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_3.svg" src="_images/ToasterOven_2_3.svg" /></div>
</a>
<p>The event processor will use this structure to determine how to behave.</p>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-do-i-use-the-return-status-with-the-callbacks"><strong>How do I use the return_status with these callbacks?</strong></p>
<p>The event processor will send events to your state callback function.  Your
state callback function will return information to the event processor telling
it how it responded to that event.  There are only certain types of responses
that are permitted with the Miros Samek event processor, and this information is
enumerated in the <code class="docutils literal notranslate"><span class="pre">return_status</span></code> object.</p>
<p>The event processor flips back and forth between searching the graph and
sending events to your callbacks to provide the expected behavior of your HSM.</p>
<p>As an application developer you shouldn’t care about the inner workings of the
event processing algorithm.  So just follow some simple conventions:</p>
<ul class="simple">
<li>set status to <code class="docutils literal notranslate"><span class="pre">UNHANDLED</span></code> at the top of your callback:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">return_status.UNHANDLED</span></code></li>
<li>if your callback handles an internal event, <code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code>, <code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code>
or <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> set status to <code class="docutils literal notranslate"><span class="pre">HANDLED</span></code>:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">return_status.HANDLED</span></code></li>
<li>if your callback uses a hook, set the status to <code class="docutils literal notranslate"><span class="pre">HANDLED</span></code>:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">return_status.HANDLED</span></code></li>
<li>if your callback needs to transition to another state, let the <code class="docutils literal notranslate"><span class="pre">trans</span></code> set
the status variable:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">oven.trans(&lt;some_state&gt;)</span></code></li>
<li>in the else clause also set the status to <code class="docutils literal notranslate"><span class="pre">SUPER</span></code>:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">return_status.SUPER</span></code></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">  <span class="c1"># set the status variable to the default</span>
</span><span class="hll">  <span class="c1"># UNHANDLED attribute</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span>  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
</span><span class="hll">    <span class="c1"># this is an internal event so we set</span>
</span><span class="hll">    <span class="c1"># the status to the HANDLED attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># this is an external event causing a transition</span>
</span><span class="hll">    <span class="c1"># so we let the trans method set the status</span>
</span><span class="hll">    <span class="c1"># attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># this is an external event causing a transition</span>
</span><span class="hll">    <span class="c1"># so we let the trans method set the status</span>
</span><span class="hll">    <span class="c1"># attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># this is an internal event so we set</span>
</span><span class="hll">    <span class="c1"># the status to the HANDLED attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># this is an external event causing a transition</span>
</span><span class="hll">    <span class="c1"># so we let the trans method set the status</span>
</span><span class="hll">    <span class="c1"># attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="c1"># this is the else clause, set your status</span>
</span><span class="hll">    <span class="c1"># to SUPER</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I haven’t talked about how to implement a hook yet, you will see this in a
future design iteration.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-does-this-toaster-oven-example-relate-to-humans-in-the-story"><strong>How does this toaster oven example relate to humans in the story?</strong></p>
<p>Let’s consider the HSM:</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_0.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_0.svg" src="_images/ToasterOven_3_0.svg" /></div>
</a>
<p>The humans in the story are the bouncers, the greeters and the bartenders, they
all exist on the earth, which is just the HSM in the metaphor.</p>
<p>The entry and exit bouncers and the greeters are internal events:</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_1.svg" src="_images/ToasterOven_3_1.svg" /></div>
</a>
<p>The bartenders, are the user defined arrows and hooks, they are the external
events:</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_2.svg" src="_images/ToasterOven_3_2.svg" /></div>
</a>
<p>Each of these humans exist as a cause in your callback’s if-elif clause
structure.  To participate in their “hack the human” campaign, to give their life
some meaning, you place your code between their clause and how you set the return
status for that clause.  To give the bartenders their secrets, you use the
<code class="docutils literal notranslate"><span class="pre">trans</span></code> method, to transition to a different state.  To have a greeter move
Spike and Tara along, again, you use the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># entry bouncer clause</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="c1"># hacking this human</span>
    <span class="c1"># Every time he talks to Spike he</span>
    <span class="c1"># will turn our oven light&#39;s off!</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="c1"># a bartender named &#39;Baking&#39;</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="c1"># his secret to Tara is to go to the baking terrace</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>

  <span class="c1"># a bartender named &#39;Toasting&#39;</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="c1"># his secret to Tara is to go to the toasting terrace</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>

  <span class="c1"># This is the terrace&#39;s greeter</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="c1"># if Spike and Tara arrive and settle on the terrace</span>
    <span class="c1"># will will tell Tara they need to proceed to the</span>
    <span class="c1"># off terrace</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>

  <span class="c1"># A bartender named &#39;Off&#39;</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="c1"># his secret to Tara is to go to the off terrace</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>

  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># Tara can&#39;t find her answer, so she throw&#39;s her</span>
    <span class="c1"># event into oblivion</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>

  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I haven’t talked about how to implement a hook yet, you will see this in a
future design iteration.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="what-does-posting-the-events-do"><strong>What does posting the events do?</strong></p>
<p>We post the events at the bottom part of our file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
</span>  <span class="c1"># toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># turn the oven off</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code is running in the main thread.  The statechart’s thread is
started with the <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call.  After this call, your program is running
two threads.</p>
<p>Your oven thread starts up it’s event processor, attaches to your callback
graph, searches it and determines how to get <code class="docutils literal notranslate"><span class="pre">off</span></code>. ;)</p>
<p>While this is happening your main thread is posting events into the oven
thread’s first in first out queue.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="c1"># toast something</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
</span>  <span class="c1"># bake something</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
</span>  <span class="c1"># turn the oven off</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
</span>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>This queue is “thread safe”, which means that it can be shared across two
threads.</p>
<p>When the oven’s thread finally finishes processing your <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call, and it has
situated, <strong>S</strong> and <strong>T</strong> in the off state, it checks it’s queue to see if
anything is there.</p>
<p>Remember this picture from the story?</p>
<a class="reference external image-reference" href="_static/md_theo.pdf"><div align="center" class="align-center"><img alt="_images/md_theo.svg" src="_images/md_theo.svg" /></div>
</a>
<p>The Theo in our toaster oven example is the oven thread, and after finishing its
<code class="docutils literal notranslate"><span class="pre">start_at</span></code> call, it’s queue will look like this:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_4.svg" src="_images/ToasterOven_2_4.svg" /></div>
</a>
<p>It sees the first posted event,
<code class="docutils literal notranslate"><span class="pre">Event(signal=signals.Toasting))</span></code> and it passes this information to the event
processor which eventually causes a transition into the <code class="docutils literal notranslate"><span class="pre">baking</span></code> state.</p>
<p>Meanwhile your main thread has probably finished processing, and it would like
to exit.  If it were to exit, the oven thread wouldn’t get a chance to do all of
it’s work.  It still needs to process the “Baking” and “Off” events.</p>
<p>So, we place a <code class="docutils literal notranslate"><span class="pre">time.sleep(0.01)</span></code> at the end of our file, to let the oven
thread finish its work before the main thread exits and kills the oven thread.</p>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="where-are-the-signal-names-defined"><strong>Where are the event names defined?</strong></p>
<p>The event names are called signals.  A signal has a name and a number.  The
number needs to be unique for each signal.</p>
<p>If you were making your statecharts in c/C++ your signal numbers would be
defined as an enumeration.  But miros is written in Python, so the signals are
objects just like everything else.</p>
<p>The internal signal names, <code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code>, <code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code>, <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code>
are defined within the miros.event package, but you can access them by importing
<code class="docutils literal notranslate"><span class="pre">signals</span></code> into your program:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
</pre></div>
</div>
<p>To get access to the internal signal objects:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span>
<span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span>
<span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span>
</pre></div>
</div>
<p>The external signals, or the events that you define in your program, are created
at the moment they are used.   Specifically when you reference an attribute of
the <code class="docutils literal notranslate"><span class="pre">signals</span></code> object that doesn’t exist within it.  This creation only happens
once, so the signal’s name and number remain unique across the life of the
program.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># signals object does not have a New signal</span>
<span class="n">some_event_the_system_has_never_seen</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">New</span><span class="p">)</span>
<span class="c1"># signals object now has a New signal, it has been assigned a unique number</span>
<span class="c1"># and the name &quot;New&quot;</span>
</pre></div>
</div>
<p>So do you need to care about this?  No, you just need to remember to type,
<code class="docutils literal notranslate"><span class="pre">Event(signal=signals.&lt;whatever_name_you_want&gt;)</span></code> and not worry about defining
things before you use them.</p>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="what-are-s-and-t-exactly-why-not-just-talk-about-s"><strong>What are S and T exactly?  Why not just talk about S?</strong></p>
<p>The event processor performs two different tasks, it discovers how your HSM is
structured and it follows the entry, exit and init rules described above.  You
can think of these tasks in more general terms as, <em>planning</em> and <em>acting</em>.</p>
<p>The current state of your statemachine is called <strong>S</strong>, or the <em>source state</em>.
If your statechart receives an event that is not handled within it’s source state,
the event processor will have to search the next most outer state, then its next
most outer state, until it finds code that knows what to do with the event.
While it searches a state, it marks them as <strong>T</strong>, which stands for the <em>target
state</em>.</p>
<p>The event processor’s planning phase involves it moving <strong>T</strong> from <strong>S</strong>, and
making a list of the things it needs to do.  When <strong>T</strong> stops on an outer state
that can handle the event, by finding a <code class="docutils literal notranslate"><span class="pre">trans</span></code> call, the event processor
stops planning and starts to act.</p>
<p>To act on the plan, the event processor marches <strong>S</strong> outward, towards <strong>T</strong>.
It’s plan would be made up of a list of functions that need to be exited.</p>
<p>Once <strong>S</strong> is positioned in the state that had the <code class="docutils literal notranslate"><span class="pre">trans</span></code> call, the event
processor would begin another planning stage.  It would place <strong>T</strong> on the inner
target state, the argument to the <code class="docutils literal notranslate"><span class="pre">trans</span></code> call, and make a list of functions that
have to be entered for <strong>S</strong> to march toward <strong>T</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The only way that the event processor knows that a <code class="docutils literal notranslate"><span class="pre">trans</span></code> call was found is
by monitoring the callback’s return_status</p>
<div class="last highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ..</span>
<span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
<span class="c1"># ..</span>
<span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div>
<p>It would then act on the plan, and march <strong>S</strong> inward, back to <strong>T</strong>.</p>
<p>Once <strong>S</strong> and <strong>T</strong> are back within the same state, the event processor looks
to see if its init condition, the big black dot on the diagram, has another
<code class="docutils literal notranslate"><span class="pre">trans</span></code> call, or arrow pointing to another inner state.  If it does, it plans
then acts on this call, and re-settles deeper within the HSM.  This process
would repeat until there was nothing left to do.</p>
<p>If this isn’t clear, the upcoming examples will show how these dynamics work.</p>
<p>So why even mention <strong>T</strong>?  As an application developer, you only really care
about <strong>S</strong> right?  Well, no, you can hack the planning stage of the event
processor and make it do useful work.</p>
<p>While <strong>T</strong> is leaving an inner state, looking for an outer state with a
<code class="docutils literal notranslate"><span class="pre">trans</span></code> call, you can create an elif clause that handles this event in an
outer state, then instead of calling <code class="docutils literal notranslate"><span class="pre">trans</span></code>, you just return HANDLED.  This
will run your code then snap <strong>T</strong> back to <strong>S</strong> and the process is completed,
this is called a hook.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ..</span>
<span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
  <span class="c1"># add your hook code here</span>
  <span class="c1"># the planning state of the event processor will</span>
  <span class="c1"># run this code, then just snap back to S</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="c1"># ..</span>
<span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>You can use hooks to define common behaviors in the outer states of your HSM.
These behaviors can be shared by all of the inner states.  To get access to this
behavior, you would send your statechart an event that would trigger the hook
and your state machine would run the hook’s code and not change states.</p>
<p>This plan-hacking is a very powerful feature of the Miro Samek algorithm.  There
are no hooks in this iteration.  They will be introduced in a future iteration.</p>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-this-statechart-starts"><strong>Can you explain how this statechart starts?</strong></p>
<p>Let’s talk about how the statechart starts.  In code we see it build an oven,
then started it in its off state:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oven</span> <span class="o">=</span> <span class="n">ToaterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;oven&#39;</span><span class="p">)</span>
<span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
</pre></div>
</div>
<p>Before the oven is started, both <strong>S</strong> and <strong>T</strong>, start outside of the HSM:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_1.svg" src="_images/ToasterOven_2_5_1.svg" /></div>
</a>
<p>The <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call places <strong>T</strong> in the off state, starts the thread and begins
the event processor:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_2.svg" src="_images/ToasterOven_2_5_2.svg" /></div>
</a>
<p>The event processor constructs a plan for how to get <strong>S</strong> to <strong>T</strong>.</p>
<p>Next, the plan is put into action;  <strong>S</strong> will start walking through
the entry conditions to re-join <strong>T</strong>; it’s first step will trigger the entry
condition of the door_closed state:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_3.svg" src="_images/ToasterOven_2_5_3.svg" /></div>
</a>
<p>This means that the event processor will call the door_closed state with an
ENTRY_SIGNAL event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Your <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> callback will catch this event with its if clause, use the
active object’s <code class="docutils literal notranslate"><span class="pre">light_off</span></code> method to turn off the light, then return
<code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code>, to let the event processor know it handled the
ENTRY_SIGNAL event.</p>
<p>Next, <strong>S</strong> rejoins <strong>T</strong> in the off state, this will trigger the off state’s
entry condition:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_4.svg" src="_images/ToasterOven_2_5_4.svg" /></div>
</a>
<p>To trigger the off state’s entry condition the event processor will send the
<code class="docutils literal notranslate"><span class="pre">off</span></code> state callback an ENTRY_SIGNAL event.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">off</span></code> callback catches the ENTRY_SIGNAL event in its if clause, prints
“off” to the terminal and let’s the event processor know it handled the event.</p>
<p>Next, the event processor calls the <code class="docutils literal notranslate"><span class="pre">off</span></code> state with an INIT_SIGNAL event.
There is no if-elif clause for this event in the <code class="docutils literal notranslate"><span class="pre">off</span></code> function, because we
don’t need to initialize the off state in this design.  So the callback notifies
the event processor that it doesn’t handle this condition by returning
<code class="docutils literal notranslate"><span class="pre">return_status.SUPER</span></code>; in effect the event is ignored:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Now the event processor has finished its <code class="docutils literal notranslate"><span class="pre">start_at</span></code> work.  The first run RTC
process is completed and the oven’s thread pends on its queue.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_5.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_5.svg" src="_images/ToasterOven_2_5_5.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-this-statechart-toasts"><strong>Can you explain how this statechart can transition from off to toasting?</strong></p>
<p>The starting state is <code class="docutils literal notranslate"><span class="pre">off</span></code>, meaning that both <strong>S</strong> and <strong>T</strong> are in the off
state.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_1.svg" src="_images/ToasterOven_2_6_1.svg" /></div>
</a>
<p>To toast, we need to send the oven a Toasting event.  This is how we do it with
the miros package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
</pre></div>
</div>
<p>The above code places the “Toasting” event into the oven’s FIFO:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_2.svg" src="_images/ToasterOven_2_6_2.svg" /></div>
</a>
<p>The oven’s thread takes the Toasting event off the queue and passes it to the
event processor.  <strong>T</strong> begins its search; the event processor calls the
<code class="docutils literal notranslate"><span class="pre">off</span></code> state with a Baking event.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_3.svg" src="_images/ToasterOven_2_6_3.svg" /></div>
</a>
<p>There is no if-elif clause in the <code class="docutils literal notranslate"><span class="pre">off</span></code> state callback, so it’s else clause is
triggered:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</div>
<p>This notifies the event processor that the <code class="docutils literal notranslate"><span class="pre">off</span></code> state can’t handle the Baking
event, and it sets the next place to look to <code class="docutils literal notranslate"><span class="pre">door_closed</span></code>.  Here we see the
power of the HSM.</p>
<p>Next, <strong>T</strong> checks the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> state to see if it can handle <code class="docutils literal notranslate"><span class="pre">Event(signal=signals.Baking)</span></code>:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_4.svg" src="_images/ToasterOven_2_6_4.svg" /></div>
</a>
<p>To do this, the event processor calls the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> callback with a Baking event,
which is caught by an elif clause:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> function reacts to the Baking event by using the oven’s
<code class="docutils literal notranslate"><span class="pre">trans</span></code> method to request a transition to the <code class="docutils literal notranslate"><span class="pre">baking</span></code> state.  It places the
value of the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method into it’s status variable and returns whatever
this information is, to the event processor.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This means that <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> is the least common ancestor, LCA, of <code class="docutils literal notranslate"><span class="pre">off</span></code>
and <code class="docutils literal notranslate"><span class="pre">baking</span></code>.</p>
</div>
<p>Next, <strong>S</strong> begins moving to rejoin <strong>T</strong>.  It’s first step is to call the exit
condition of the off state:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_5.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_5.svg" src="_images/ToasterOven_2_6_5.svg" /></div>
</a>
<p>There is no exit condition in the <code class="docutils literal notranslate"><span class="pre">off</span></code> state code so it’s else clause is
triggered:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</div>
<p>Next, <strong>S</strong> then rejoins <strong>T</strong>, and they are now both in the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code>
state.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_6.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_6.svg" src="_images/ToasterOven_2_6_6.svg" /></div>
</a>
<p>Next, the event processor places <strong>T</strong> into baking:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_7.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_7.svg" src="_images/ToasterOven_2_6_7.svg" /></div>
</a>
<p>Next, <strong>S</strong> begins to climb into the chart so that it can rejoin <strong>T</strong>. It
start’s this journey by triggering the entry event of the heating state.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_8.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_8.svg" src="_images/ToasterOven_2_6_8.svg" /></div>
</a>
<p>To do this, the event processor sends an ENTRY_SIGNAL event to the <code class="docutils literal notranslate"><span class="pre">heating</span></code> state callback:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The ENTRY_SIGNAL is caught by an elif clause, which will turn the heater on and
tell the event processor it handled the event.</p>
<p>Next, <strong>S</strong> enters the heating state to rejoin <strong>T</strong></p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_9.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_9.svg" src="_images/ToasterOven_2_6_9.svg" /></div>
</a>
<p>To do this the event processor calls the <code class="docutils literal notranslate"><span class="pre">baking</span></code> callback with an ENTRY_SIGNAL event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">baking</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;baking&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p><strong>S</strong> and <strong>T</strong> are now settled in the baking state, so the event processor
sends an INIT_SIGNAL to the <code class="docutils literal notranslate"><span class="pre">baking</span></code> callback to see if it needs to transition
deeper into the statechart.  There is no init handle for this state, so this
event is ignored.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is only one handled init signal in the whole design and it’s in the
door_closed state.  It will never be called because we start the statechart in
the off state.  If were where to start the statechart in the door_closed
state, this init event would be triggered, causing the statemachine to
ultimately settle into the off state.</p>
</div>
<p>Another run to completion process has been finished, so the oven thread, looks
back to it’s queue to see if any other thread posted event’s to it while it was
trying to toast something:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_5.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_5.svg" src="_images/ToasterOven_2_5_5.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="is-there-a-way-i-can-get-miros-to-show-me-what-happened-and-how-it-happened"><strong>Is there a way I can get miros to show me what happened and how it happened?</strong></p>
<p>Yes, in fact there are two different ways to show you what happened and how it
happened.  If you instrument your state callbacks using the <code class="docutils literal notranslate"><span class="pre">spy_on</span></code>
decorator, you can use either the <code class="docutils literal notranslate"><span class="pre">trace</span></code> or <code class="docutils literal notranslate"><span class="pre">spy</span></code> output.</p>
<p>I will break this answer up into two parts, what you can see with either a
trace or a spy, and how you can use these tools to make sense of your own
designs.</p>
<p><em>What you can see with a trace:</em></p>
<p>We have talked about how the statecharts starts in the off state, now let’s look
at how this was reported by the <code class="docutils literal notranslate"><span class="pre">trace</span></code> instrumentation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">51.890583</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">off</span>
</pre></div>
</div>
<p>It describes:</p>
<blockquote>
<div><ul class="simple">
<li>when the event happened,</li>
<li>in what statechart: oven</li>
<li>what event caused the transition: start_at</li>
<li>the starting state: top</li>
<li>the ending state: off.</li>
</ul>
</div></blockquote>
<p>We have also talked about how the oven transitions from off to the toasting
state.  Here is what was reported by the <code class="docutils literal notranslate"><span class="pre">trace</span></code> instrumentation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">51.891473</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Toasting</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">toasting</span>
</pre></div>
</div>
<p>It describes:</p>
<blockquote>
<div><ul class="simple">
<li>when the event happened,</li>
<li>in what statechart: oven,</li>
<li>what event caused the transition: “Toasting”</li>
<li>the starting state: off</li>
<li>the ending state: toasting</li>
</ul>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">trace</span></code> is a useful tool to get a very rough understanding about what has
happened with a statechart, but consider all of the information that is missing:</p>
<blockquote>
<div><ul class="simple">
<li>It does not report on the entry triggers and init triggers.</li>
<li>It does not describe how the event processor searched your callbacks to discover how the
HSM is structured.</li>
</ul>
</div></blockquote>
<p>To see this information you can use the <code class="docutils literal notranslate"><span class="pre">spy</span></code> instrumentation.</p>
<p><em>What you can see with the spy:</em></p>
<p>Here is the spy output resulting from the <code class="docutils literal notranslate"><span class="pre">oven.start_at(off)</span></code> call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">START</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The spy output describes an event’s signal name and which state it is expressed in.</p>
<p>From the spy output we can monitor the event processor planning and acting
stages.  For instance in the above spy output, we can see the event processor
query the off state and door_closed state with the SEARCH_FOR_SUPER_SIGNAL
event.  This is done so that it can know how to enter the statemachine, then it
acts on this plan by entering the door_closed state, then the off state, then it
settles into the off state by sending it an INIT_SIGNAL event.</p>
<p>At the end of this RTC process, we see what is waiting in the queues for the next
RTC process.  We have only been talking about one queue so far, and that is the
first queue in the listing.  The Deferred queue is something you will learn
about in the patterns section.</p>
<p>Here is the spy output for the chart transitioning from the off state to the
toasting state:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Toasting</span><span class="p">:</span><span class="n">off</span>
<span class="n">Toasting</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">2</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The SEARCH_FOR_SUPER_SIGNAL event lines in the spy output can be confusing to look at.  Miro
Samek’s event processing algorithm has to consider 7 different graph topologies,
so as an application developer you might know how and why these calls are taking
place.  Instead, pay attention to the other things in the output:</p>
<blockquote>
<div><ul class="simple">
<li>The off state is sent the Toasting event signal (which it doesn’t handle)</li>
<li>The door_closed state is sent the Toasting event (which causes a trans)</li>
<li>The off state is sent the EXIT_SIGNAL event</li>
<li>The heating state is sent the ENTRY_SIGNAL event</li>
<li>The toasting state is sent the ENTRY_SIGNAL event</li>
<li>The toasting state is sent the INIT_SIGNAL</li>
</ul>
</div></blockquote>
<p>Finally, we see the line describing the state of the queues.  In this case their
are two events pending in the queue, due to our code calling the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code>
method with a “Baking” and “Off” event.</p>
<p>To turn on a live spy, replace the live_trace call with the live_spy call in
your code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oven</span><span class="o">.</span><span class="n">list_spy</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-this-statechart-bakes"><strong>Can you explain how this statechart bakes?</strong></p>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-this-statechart-turns-off"><strong>Can you explain how this statechart turns off?</strong></p>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-are-you-putting-state-into-the-toasteroven-and-not-its-hsm"><strong>Why are you putting state information into the ToasterOven and not its HSM?</strong></p>
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-3-open-door">
<span id="iter3"></span><h3>Iteration 3: open door<a class="headerlink" href="#iteration-3-open-door" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>The toaster’s heating element should turn off when the door is opened</li>
<li>The toaster should turn on it’s light when the door is opened</li>
</ul>
</div>
<div class="section" id="iteration-4-adding-some-history">
<span id="iter4"></span><h3>Iteration 4: adding some history<a class="headerlink" href="#iteration-4-adding-some-history" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>When a customer closes the door, the toaster oven should go back to behaving
like it was before.</li>
</ul>
</div>
<div class="section" id="iteration-5-adding-a-buzzer">
<span id="iter5"></span><h3>Iteration 5: adding a buzzer<a class="headerlink" href="#iteration-5-adding-a-buzzer" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>While the toaster oven is in any state the customer should be able to press a buzzer which will
get the attention of anyone nearby.</li>
</ul>
</div>
<div class="section" id="iteration-6-adding-cook-times">
<span id="iter6"></span><h3>Iteration 6: adding cook times<a class="headerlink" href="#iteration-6-adding-cook-times" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>The toaster oven should stay in the baking state for twenty seconds, then buzz
and turn off.</li>
<li>The toaster oven should stay in the toasting state for ten seconds, then buzz
and turn off.</li>
<li>If the door is opened, then closed, the cooking time should be set back to
it’s default time of ten or twenty seconds.</li>
</ul>
<a class="reference external image-reference" href="_static/ToastOven_1.pdf"><div align="center" class="align-center"><img alt="_static/ToastOven_1.svg" src="_static/ToastOven_1.svg" /></div>
</a>
<a class="reference internal" href="quickstart.html"<span class="std-ref">prev</span></a>, <a class="reference internal" href="index.html#top"><span class="std std-ref">top</span></a>, <a class="reference internal" href="reading_diagrams.html"><span class="std std-ref">next</span></a></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Zero To One</a><ul>
<li><a class="reference internal" href="#story">Story</a></li>
<li><a class="reference internal" href="#a-simple-example-toaster-oven">A Simple Example: Toaster Oven</a><ul>
<li><a class="reference internal" href="#iteration-1-setup">Iteration 1: setup</a></li>
<li><a class="reference internal" href="#iteration-2-basic-oven">Iteration 2: basic oven</a></li>
<li><a class="reference internal" href="#iteration-3-open-door">Iteration 3: open door</a></li>
<li><a class="reference internal" href="#iteration-4-adding-some-history">Iteration 4: adding some history</a></li>
<li><a class="reference internal" href="#iteration-5-adding-a-buzzer">Iteration 5: adding a buzzer</a></li>
<li><a class="reference internal" href="#iteration-6-adding-cook-times">Iteration 6: adding cook times</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="quickstart.html" title="previous chapter">Quick Start</a></li>
      <li>Next: <a href="reading_diagrams.html" title="next chapter">Diagrams</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/zero_to_one.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Scott Volk.
      
      |
      <a href="_sources/zero_to_one.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>