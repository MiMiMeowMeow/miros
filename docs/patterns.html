
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Patterns &#8212; miros 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Reflection" href="reflection.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <table class="hlist"><tr><td><ul class="simple">
<li><a class="reference internal" href="#patterns-ultimate-hook"><span class="std std-ref">ultimate hook</span></a></li>
<li><a class="reference internal" href="#patterns-reminder"><span class="std std-ref">reminder</span></a></li>
<li><a class="reference internal" href="#patterns-deferred-event"><span class="std std-ref">deferred event</span></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="#patterns-orthogonal-component"><span class="std std-ref">orthogonal component</span></a></li>
<li><a class="reference internal" href="#patterns-transition-to-history"><span class="std std-ref">transition to history</span></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="#patterns-multichart-race"><span class="std std-ref">multichart race</span></a></li>
<li><a class="reference internal" href="#patterns-multichart-pend"><span class="std std-ref">multichart pend</span></a></li>
</ul>
</td></tr></table>
<div class="section" id="id1">
<h1>Patterns<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>The idea of software design patterns came from the architect Christopher
Alexander.  He wrote a book, <a class="reference external" href="https://www.patternlanguage.com/">a pattern language</a>, about how different approaches
to architecture could be used across different scales (from the country to the
pantry) to help people feel better about living in their communities.  It’s a
lovely book; a child can understand it yet it is still useful to professional
architects.</p>
<p>This can not be said for the book it inspired in computer science, “Design
Patterns: Elements of Reusable Object-Oriented Software”  This book <em>was not</em>
child friendly, in fact everyone I knew secretly hated it because of its
illegibility; but would make sure to have a copy of it on their shelf to look
like they were in the club.</p>
<p>The ideas within the book were great and the follow up books that <a class="reference external" href="https://www.tutorialspoint.com/design_pattern/design_pattern_overview.htm">translated
it into English</a> were really useful.  Basically it described a set of
techniques for solving classes of problems that come up over and over again.
If you haven’t learned the patterns yet, find a copy of a patterns book written
by a practitioner in your language(s) and work through it.  You will level up.</p>
<p>In chapter 5 of “Practical UML STATECHARTS in C/C++” I was leveled up by Miro
Samek.  He describes 5 statechart patterns and made the bold claim that
<strong>statecharts are a pattern of patterns</strong>.  I completely agree with him.  So here
is my translation of his work into this library.  I’ll start each pattern with
quotes from his book, then write about it within the context of this work.</p>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="ultimate-hook">
<span id="patterns-ultimate-hook"></span><h2>Ultimate Hook<a class="headerlink" href="#ultimate-hook" title="Permalink to this headline">¶</a></h2>
<p>Formal description:</p>
<blockquote>
<div><p>[The Ultimate Hook Pattern provides a] common facilities and policies for
handling events but let clients override and specialize every aspect of the
system’s behavior.</p>
<p>The semantics of state nesting provide the desired mechanism of handling
all events, first in the context of the client code (the nested state) and
of automatically forwarding of all unhandled events to the [parent state]
(the default behavior). In that way, the client code intercepts every
stimulus and can override every aspect of the behavior. To reuse the
default behavior, the client simply ignores the event and lets the
superstate handle it (the [child state] inherits behavior from the
superstate) <a class="footnote-reference" href="#id5" id="id2">[4]</a></p>
</div></blockquote>
<p>Makes sense to me.  Keep up! ;)</p>
<p>To understand the ultimate hook pattern, you first have to understand what a
hook is.  It is just some code in an <code class="docutils literal"><span class="pre">if-elif</span></code> clause.   A hook is just some
code that catches an event, runs your <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> and then
returns something which tells the event processor to stop searching.  <strong>A hook
doesn’t cause a state transition</strong>.  It is a way to get the event processor’s
search algorithm to do work for you without changing state.</p>
<p>You see, anytime the event processor is trying to figure out what to do with an
event it needs to <a class="reference internal" href="recipes.html#recipes-what-a-state-does-and-how-to-structure-it"><span class="std std-ref">search your
statechart</span></a>.  If it finds
that it needs to do a transition, it will enlist the heavy-duty parts of it’s
algorithm to make sure that the <a class="reference internal" href="glossary.html#term-harel-formalism"><span class="xref std std-term">Harel Formalism</span></a>
occurs.  The hook has nothing to do with this, because it short circuits the
search before it does a transition, but not before it gets this search algorithm
to do some useful work.</p>
<p>If your if-else structure in your state method catches the signal name of an
event, runs your code, then returns the <code class="docutils literal"><span class="pre">return_status.HANDLED</span></code> back to the
event processor, no state transition will occur.  This is how you make a hook.
You make sure that part of your if-elif clause catches the event signal, runs
your <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> and returns the <code class="docutils literal"><span class="pre">return_state.HANDLED</span></code>
value.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook1.svg" src="_images/ultimate_hook1.svg" /></div>
<p>Here is a simple example which demonstrates a hook.  In this example we will
show that we can get some client code to run when we post an event with the
signal name of BEHAVIOR_NAME to your statechart:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">spy_on</span><span class="p">,</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># your code would go here</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your outer_state code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>The highlighted code describes the hook.  We see that when the BEHAVIOR_NAME
signal is caught by this state method it runs your <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> then returns <code class="docutils literal"><span class="pre">return_status.HANDLED</span></code>.</p>
<p>The <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> output would look like this:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BEHAVIOR_NAME:outer_state&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;your outer_state code here&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;BEHAVIOR_NAME:outer_state:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Lines 1-5 describe the first <a class="reference internal" href="glossary.html#term-run-to-completion"><span class="xref std std-term">rtc</span></a> event which occurs
when we start the statechart.  Lines 5-9 of the
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log actually describe the hook behavior.  The
event processor ran, searching the statechart starting at the outer_state
method to see if it knew how to process the BEHAVIOR_NAME signal and it did:
the <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> just
<a class="reference internal" href="recipes.html#recipes-scribble-on-the-spy"><span class="std std-ref">scribbled</span></a> something into our
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log so we can see what happened.  On line 7
we see the result of this in the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log.
Furthermore, no state transition occurred.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook2.svg" src="_images/ultimate_hook2.svg" /></div>
<p>Now suppose we add another state within the outer state and start our active
object there.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">spy_on</span><span class="p">,</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>


<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
    <span class="c1"># your code would go here</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your outer_state code here&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="hll"><span class="nd">@spy_on</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># your code would go here</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your inner_state code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">outer_state</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="hll"><span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
</span><span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>Then look at the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BEHAVIOR_NAME:inner_state&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;your inner_state code here&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;BEHAVIOR_NAME:inner_state:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Ok, no surprises.  The inner_state hooked the BEHAVIOR_NAME signal and
ran some <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a>.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook3.svg" src="_images/ultimate_hook3.svg" /></div>
<p>Now let’s remove the handling of the BEHAVIOR_NAME from our
inner state and see what happens when we start the active object in the
inner_state then send it an event with the BEHAVIOR_NAME.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">spy_on</span><span class="p">,</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
    <span class="c1"># your code would go here</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your outer_state code here&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="c1">#if(e.signal == signals.BEHAVIOR_NAME):</span>
  <span class="c1">#  # your code would go here</span>
  <span class="c1">#  chart.scribble(&quot;your inner_state code here&quot;)</span>
  <span class="c1">#  status = return_status.HANDLED</span>
  <span class="c1">#else:</span>
  <span class="c1">#  chart.temp.fun = outer_state</span>
  <span class="c1">#  status = return_status.SUPER</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>

<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>In the highlighted code you can see that I adjusted the inner_state to run as
if it’s <code class="docutils literal"><span class="pre">else</span></code> method clause was always active.  I did this so that it would not
handle the BEHAVIOR_NAME signal.  Now we run the code and look at the
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> output.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;BEHAVIOR_NAME:inner_state&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;BEHAVIOR_NAME:outer_state&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;your outer_state code here&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;BEHAVIOR_NAME:outer_state:HOOK&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>The highlighted lines show how our event processor tried to determine what to
do with the event containing the BEHAVIOR_NAME signal.</p>
<p>It called the inner_state with the event (8), it wasn’t handled, so it
called the parent outer_state with the same event (9) and we see on
line (10) that the outer_state <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> was run.  Finally, on line (11)
the spy instrumentation tells us that it detected a hooked event.  When you see
this in the log it means there was no state transition.</p>
<p>So, the outer_state hook code caught an event that was sent to the
inner_state.  The <a class="reference internal" href="glossary.html#term-harel-formalism"><span class="xref std std-term">Harel Formalism</span></a> followed by the
event processor determines that when it has an event, it will search outward
from the current state, to the next <a class="reference internal" href="glossary.html#term-parent-state"><span class="xref std std-term">parent state</span></a>, then the next parent state
over and over until your event is handled or, it reaches the top most state of
your <a class="reference internal" href="glossary.html#term-hierarchical-state-machine"><span class="xref std std-term">HSM</span></a>. This means that any inner state
method will automatically inherit the hook code of any outer state.  The outer
most state contains the ultimate hook; this is why the pattern is called what
it is.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook4.svg" src="_images/ultimate_hook4.svg" /></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To show that there is some sort of explicit design feature occuring on your
diagram, something that might be too subtle for someone to see right away UML
provides a dotted-collaboration-bubble.  It is very easy to over use
this feature and clutter up your diagram.</p>
</div>
<p>You can overwrite the behavior of the outer state hooks simply by explicitly
handling the signal in an inner state.  These ideas are very similar to
inheritance and overloading in object oriented programming.</p>
<p>As a designer you would write default <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> behavior
in the outer states of charts, and all of your inner states would get this
behavior for free.  If they needed to overwrite this behavior they would
specifically handle the event in their state methods.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook5.svg" src="_images/ultimate_hook5.svg" /></div>
<p>You would place generic reactions to events in your outer states and place the
specific responses in your inner states. Let’s build out the above diagram:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="hll"><span class="k">def</span> <span class="nf">process_a_generic</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s1">&#39;processing a generic&#39;</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="hll"><span class="k">def</span> <span class="nf">process_b_generic</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s1">&#39;processing b generic&#39;</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="hll"><span class="c1"># overrides the generic hook while in the specific state</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">process_a_specific</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s1">&#39;processing a specific&#39;</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;ultimate_hook_example&#39;</span><span class="p">)</span>
<span class="n">generic</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;generic&#39;</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">process_a_generic</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">process_b_generic</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">to_method</span><span class="p">()</span>

<span class="n">specific</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;specific&#39;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">process_a_specific</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">generic</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">specific</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">specific</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>First of all we notice that instead of using an active object the diagram asks
us to use a <a class="reference internal" href="towardsthefactoryexample.html#towardsthefactoryexample-using-the-factory-class"><span class="std std-ref">factory</span></a>.
To use the factory we create states and tie specific signals to callback
functions.</p>
<p>The highlighted code shows the callback functions that are acting like hooks.
Pay special attention to what they return.  If they do not return
<code class="docutils literal"><span class="pre">return_status.HANDLED</span></code> they will not work as hooks.</p>
<p>We can deterime if we got the expected behavior by looking at the
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:generic&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:generic&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;b:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;b:generic&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;processing b generic&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;b:generic:HOOK&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;a:specific&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;processing a specific&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;a:specific:HOOK&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>On lines 10 and 11 we see the reaction to our first <code class="docutils literal"><span class="pre">b</span></code> signal.  As expected
the generic state’s hook function was run while the statechart remained in the
specific state.</p>
<p>On lines 14 and 15 we see the specific behavior for the <code class="docutils literal"><span class="pre">a</span></code> signal.  The
statechart ran the <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> in the specific state then
stopped processing the signal.</p>
</div>
<div class="section" id="reminder">
<span id="patterns-reminder"></span><h2>Reminder<a class="headerlink" href="#reminder" title="Permalink to this headline">¶</a></h2>
<p>Formal description:</p>
<blockquote>
<div><p>“Make the statechart topology more flexible by inventing an event an posting
it to itself.</p>
<p>Often in state modeling, loosely related functions of a system are strongly
coupled by a common event. Consider, for example, periodic data acquisition,
in which a sensor producing the data needs to be polled at a predetermined
rate. Assume that a periodic TIME_OUT event is dispatched to the system at
the desired rate to provide the stimulus for polling the sensor. Because the
system has only one external event (the TIME_OUT event), it seems that this
event needs to trigger both the polling of the sensor and the processing of
the data. A straightforward but suboptimal solution is to organize the state
machine into two distinct orthogonal regions (for polling and processing).
However, orthogonal regions increase the cost of dispatching events … and
require complex synchronization between the regions because the polling and
processing are not quite independent.” <a class="footnote-reference" href="#id6" id="id3">[5]</a></p>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you find yourself drawing two separate states with a lot of arrows
connecting them, remind yourself of this <a class="reference internal" href="#patterns-reminder-here"><span class="std std-ref">reminder
pattern</span></a>.</p>
</div>
<p>The reminder pattern uses the <a class="reference internal" href="#patterns-ultimate-hook"><span class="std std-ref">ultimate hook</span></a>
pattern mixed with <a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial event</span></a> injection.  It’s
an <a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial event</span></a> because it is invented by the
statechart and injected to itself rather than being invented and injected by an
outside caller.</p>
<p>I’ll try to explain this idea by showing a bad, but working design, show how it
is expensive and then refactor the design using the <a class="reference internal" href="#patterns-reminder-here"><span class="std std-ref">reminder
pattern</span></a>.</p>
<p>We will begin with some specifications:</p>
<ul class="simple">
<li>Part of the system will poll a sensor based on a system clock running with
a period of 100ms.</li>
<li>Once polled this information will be sent to some processing code.</li>
<li>After three such events, the system will perform some processing and it will
enter a busy state (maybe communicating with a server).</li>
<li>While the unit is in a busy state it should not poll the sensor or process
input.</li>
<li>After the busy process is completed the system should go back into it’s
polling mode.</li>
</ul>
<p>Here is a first shot at implementing this specification:</p>
<div align="center" class="align-center"><img alt="_images/reminder1.svg" src="_images/reminder1.svg" /></div>
<p>We create a polling state which upon entry poles something.  Any time there is
a time out it will re-enter the state making this happen.</p>
<p>Then when it initializes it transitions into the processing state.  Upon
entering the processing state we add one to the <code class="docutils literal"><span class="pre">chart.processing_count</span></code> and
then process the message.  When the processing state initializes itself it will
either go back to the polling state or enter the busy state, if the
<code class="docutils literal"><span class="pre">chart.processing_count</span></code> is high enough.</p>
<p>Upon entering the busy state the <code class="docutils literal"><span class="pre">chart.busy_count</span></code> is set to zero.  Then the
TIME_OUT event is used with a <span class="xref std std-term">hook</span> to work the information.  In
this example we just scribble “busy” into the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a>
log.  Then we add 1 to our <code class="docutils literal"><span class="pre">chart.busy_count</span></code>.  If the count is big enough we
transition back to the polling state.  Upon exiting the processing state, the
<code class="docutils literal"><span class="pre">chart.processing_count</span></code> is set to 0.  That should work!</p>
<p>Actually, it won’t work at all.</p>
<p>Notice the large <strong>Xs</strong> on the diagram.  These are there to show that they
are illegal transitions.  The Miro Samek event processing algorithm will only
allow INIT_SIGNAL events to drill further into child states; they can not leave there
current state and navigate to another region of the chart.  I’ll just pretend I
didn’t know about this and continue.</p>
<p>Let’s see what happens when we try to make this broken statechart</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">polling_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">polling_enter</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_state</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">polling_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">  <span class="c1"># illegal (init can&#39;t leave parent states)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>
</span>
<span class="k">def</span> <span class="nf">processing_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
<span class="hll">    <span class="c1"># illegal (init can&#39;t leave parent states)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
</span>  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">processing_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;reminder_pattern_needed_1&#39;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;processing_count&quot;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;busy_count&quot;</span><span class="p">)</span>

<span class="n">polling</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_time_out</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PROCESS</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">processing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_entry</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_exit</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">busy</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_time_out</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">polling</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">processing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">busy</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">),</span> <span class="n">times</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>I have highlighted the <a class="reference internal" href="glossary.html#term-illegal-transition"><span class="xref std std-term">illegal transitions</span></a>.</p>
<p>If we run the code we will see:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">miros</span><span class="o">.</span><span class="n">hsm</span><span class="o">.</span><span class="n">HsmTopologyException</span><span class="p">:</span>
  <span class="n">impossible</span> <span class="n">chart</span> <span class="n">topology</span> <span class="k">for</span> <span class="n">HsmEventProcessor</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
  <span class="n">see</span> <span class="n">HsmEventProcessor</span><span class="o">.</span><span class="n">init</span> <span class="n">doc</span> <span class="n">string</span> <span class="k">for</span> <span class="n">details</span>
</pre></div>
</div>
<p>So, how do we make this software work?  When you see this
<span class="xref std std-term">HsmToplogyException</span>, it’s probably time to
consider another way to design your <a class="reference internal" href="glossary.html#term-statechart"><span class="xref std std-term">statechart</span></a>.  We will
get to that shortly, but for now let’s find a way to force this software to
work the way we want it to.</p>
<p>Instead of making the INIT_SIGNAL transition outside of the state, we could
invent a new signal, post it to ourselves and pretend like it came from outside
of the active object.  Then our chart could react to it like it would to any
other event.  This kind of thing is called an <a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial
event</span></a>.  Here is the code that would create an artificial
PROCESS event:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># If &#39;PROCESS&#39; signal wasn&#39;t invented before invent it now</span>
<span class="c1"># We post it to ourselves so we can react to it in the next rtc.</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PROCESS</span><span class="p">))</span>
</pre></div>
</div>
<p>Now that we know how to do that let’s redesign our statechart:</p>
<div align="center" class="align-center"><img alt="_images/reminder2.svg" src="_images/reminder2.svg" /></div>
<p>This introduces a new <a class="reference internal" href="glossary.html#term-pseudostate"><span class="xref std std-term">glyph</span></a> called the final state:</p>
<div align="center" class="align-center"><img alt="_images/reminder3.svg" src="_images/reminder3.svg" /></div>
<p>When you see this <a class="reference internal" href="glossary.html#term-pseudostate"><span class="xref std std-term">glyph</span></a> on a diagram it means, stop running.  So:</p>
<div align="center" class="align-center"><img alt="_images/reminder4.svg" src="_images/reminder4.svg" /></div>
<p>Would look like this as code:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Square brackets on diagram.</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span> <span class="c1"># HEAVY-DUTY Harel Formalism run here.</span>
                               <span class="c1"># This is recursive and might take</span>
                               <span class="c1"># a while  before this</span>
                               <span class="c1"># routine finishes.</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># If &#39;POLL&#39; signal wasn&#39;t invented before invent it now.</span>
    <span class="c1"># We post it to ourselves so we can react to it in the next rtc.</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">POLL</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div></blockquote>
<p>Ok now that we have that all out of the way let’s start fresh, reconsidering
our specification and our proposed design, then implement it in code:</p>
<ul class="simple">
<li>Part of the system will poll a sensor based on a system clock running with
a period of 100ms.</li>
<li>Once polled this information will be sent to some processing code.</li>
<li>After three such events, the system will perform some processing and it will
enter a busy state (maybe communicating with a server).</li>
<li>While the unit is in a busy state it should not poll the sensor or process
input.</li>
<li>After the busy process is completed the system should go back into it’s
polling mode.</li>
</ul>
<div align="center" class="align-center"><img alt="_images/reminder2.svg" src="_images/reminder2.svg" /></div>
<p>Here is the code for this design with highlights for the <a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial
events</span></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">polling_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
</span><span class="hll">    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PROCESS</span><span class="p">))</span>
</span>  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">polling_process</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">processing_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
<span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
</span><span class="hll">      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">POLL</span><span class="p">))</span>
</span>  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">processing_poll</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">processing_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;reminder_pattern_needed_2&#39;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;processing_count&quot;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;busy_count&quot;</span><span class="p">)</span>

<span class="n">polling</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span><span class="o">.</span> \
<span class="hll">            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_time_out</span><span class="p">)</span><span class="o">.</span> \
</span>            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PROCESS</span><span class="p">,</span>  <span class="n">handler</span><span class="o">=</span><span class="n">polling_process</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">processing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_entry</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_init</span><span class="p">)</span><span class="o">.</span> \
<span class="hll">            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_exit</span><span class="p">)</span><span class="o">.</span> \
</span>            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">POLL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_poll</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">busy</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_time_out</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">polling</span><span class="p">,</span>    <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">processing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">busy</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">),</span> <span class="n">times</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>If we run this code, it will output 1 seconds worth of information. The
comments in the spy log are the thoughts I would have while viewing it.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span> <span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span> <span class="c1"># start_at code running</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># start_at code completed</span>
 <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># time out event detected in polling</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span> <span class="c1"># result of chart.scribble(&quot;polling&quot;)</span>
 <span class="s1">&#39;POST_FIFO:PROCESS&#39;</span><span class="p">,</span> <span class="c1"># inventing and posting our artificial event</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span>  <span class="c1"># TIME_OUT was a hook, no state transition</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed (event waiting)</span>
</span> <span class="s1">&#39;PROCESS:polling&#39;</span><span class="p">,</span> <span class="c1"># PROCESS event detected in polling</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;processing&#39;</span><span class="p">,</span> <span class="c1"># result of chart.scribble(&quot;processing&quot;)</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;POST_FIFO:POLL&#39;</span><span class="p">,</span> <span class="c1"># chart.post_fifo(Event(signal=signals.POLL))</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed (event waiting)</span>
</span> <span class="s1">&#39;POLL:processing&#39;</span><span class="p">,</span> <span class="c1"># polling state detected POLL event</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1">#rtc complete (no events waiting)</span>
</span> <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># second TIME_OUT event cycle described above</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:PROCESS&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;PROCESS:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:POLL&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;POLL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># third TIME_OUT event expecting something different now</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span> <span class="c1"># result of chart.scribble(&quot;polling&quot;)</span>
 <span class="s1">&#39;POST_FIFO:PROCESS&#39;</span><span class="p">,</span>  <span class="c1"># inventing and posting our artificial event</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT was a hook, no state transition</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed (event waiting)</span>
</span> <span class="s1">&#39;PROCESS:polling&#39;</span><span class="p">,</span> <span class="c1"># PROCESS event detected in polling</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;processing&#39;</span><span class="p">,</span> <span class="c1"># result of chart.scribble(&quot;processing&quot;)</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:busy&#39;</span><span class="p">,</span> <span class="c1"># busy state detect it&#39;s first TIME_OUT</span>
 <span class="s1">&#39;busy&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;busy&quot;)</span>
<span class="hll"> <span class="s1">&#39;TIME_OUT:busy:HOOK&#39;</span><span class="p">,</span> <span class="c1"># busy state hooks it and blocks it from leaving</span>
</span> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
 <span class="s1">&#39;TIME_OUT:busy&#39;</span><span class="p">,</span> <span class="c1"># busy state detects it&#39;s second TIME_OUT</span>
<span class="hll"> <span class="s1">&#39;busy&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;busy&quot;)</span>
</span> <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;EXIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
<span class="hll"> <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># full circuit completed DESIGN CONFIRMED</span>
</span><span class="hll"> <span class="c1"># deleting the rest of the log from documentation</span>
</span></pre></div>
</div>
<p>The code works and we have met our specifications.</p>
<p>But the polling and the processing state are strongly coupled to the TIME_OUT
signal.  Our design of having the TIME_OUT start the system in the polling and
end up in the processing/busy state cost us a lot of CPU time.</p>
<p>Lets introduce the reminder pattern with a new design:</p>
<div align="center" class="align-center"><img alt="_images/reminder6.svg" id="patterns-reminder-here" src="_images/reminder6.svg" /></div>
<p>Let’s discuss this diagram.</p>
<p>We use INIT_SIGNAL events to climb into the idle state.</p>
<p>We create a TIME_OUT ultimate hook, which is a method that can be used by any
state within the statechart.  This ultimate hook counts up each time it sees a
TIME_OUT and once this count hits 3 it posts an artificial event with the
signal DATA_READY.</p>
<p>Once the <a class="reference internal" href="glossary.html#term-run-to-completion"><span class="xref std std-term">RTC</span></a> process is completed, idle will catch
the DATA_READY signal and transition into busy.  The busy state catches the
TIME_OUT event which means that it will not escape to the ultimate hook in
polling.  Instead it uses it to count up a busy_count and when it hits 2 it
will transition back into idle.</p>
<p>Now, let’s write the code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">polling_time_out_hook</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;generic TIME_OUT ultimate hook for all states,</span>
<span class="sd">     injects artificial event DATA_READY&#39;&#39;&#39;</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">if</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">DATA_READY</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">polling_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">idle_data_ready</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">busy_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_time_out_hook</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;specific TIME_OUT hook for busy state&#39;&#39;&#39;</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">if</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;reminder&#39;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;processing_count&quot;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;busy_count&quot;</span><span class="p">)</span>

<span class="n">polling</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_time_out_hook</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">processing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_init</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">to_method</span><span class="p">()</span>

<span class="n">idle</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;idle&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">DATA_READY</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">idle_data_ready</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="n">busy</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_time_out_hook</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">polling</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">processing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">polling</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">idle</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">busy</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">polling</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">),</span> <span class="n">times</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>If we run the code and looked at the spy log it would look like this: (I have
marked it up with comments)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span> <span class="c1"># start_at code running</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:idle&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT detected in idle</span>
 <span class="s1">&#39;TIME_OUT:processing&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT passed out to processing</span>
 <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT passed to polling</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;polling&quot;)</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT hooked by the polling</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:idle&#39;</span><span class="p">,</span> <span class="c1"># Second TIME_OUT circuit - dynamics same as above</span>
 <span class="s1">&#39;TIME_OUT:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;TIME_OUT:idle&#39;</span><span class="p">,</span> <span class="c1"># Third TIME_OUT event</span>
 <span class="s1">&#39;TIME_OUT:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:DATA_READY&#39;</span><span class="p">,</span> <span class="c1"># Posting the artificial event to the chart</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT hooked by pooling</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed with 1 item in queue</span>
</span> <span class="s1">&#39;DATA_READY:idle&#39;</span><span class="p">,</span> <span class="c1"># DATA_READY seen by idle state</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;EXIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism (busy_entry call run)</span>
 <span class="s1">&#39;INIT_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:busy&#39;</span><span class="p">,</span> <span class="c1"># busy sees TIME_OUT event</span>
 <span class="s1">&#39;busy&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;busy&quot;)</span>
 <span class="s1">&#39;TIME_OUT:busy:HOOK&#39;</span><span class="p">,</span>  <span class="c1"># busy hooks TIME_OUT event</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:busy&#39;</span><span class="p">,</span> <span class="c1"># second TIME_OUT event seen by busy</span>
 <span class="s1">&#39;busy&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;busy&quot;)</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># this started by return chart.trans(idle)</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span> <span class="c1"># rtc completed .. full circuit demonstrated</span>
</span> <span class="o">.</span>
 <span class="o">.</span>
 <span class="p">]</span>
</pre></div>
</div>
<p>This design required a lot less CPU time.  This is especially important if you
are going to port your design to an embedded system.  If you are using Python
in production you will be much less concerned with performance (since you are
using Python), even so, it is still a better design.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you were to use the trace you might be surprised that the hooked code is
hidden from view.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.157806</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.461012</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">DATA_READY</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">busy</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.661728</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">busy</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.763392</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">DATA_READY</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">busy</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.963635</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">busy</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">23.064705</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">DATA_READY</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">busy</span>
</pre></div>
</div>
<p class="last">This is because the trace will only track items which cause state transitions
and hooks do not cause state transitions.</p>
</div>
</div>
<div class="section" id="deferred-event">
<span id="patterns-deferred-event"></span><h2>Deferred Event<a class="headerlink" href="#deferred-event" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Formal description:</dt>
<dd>“Simplify state machines by modifying the sequencing of events” <a class="footnote-reference" href="#id7" id="id4">[6]</a></dd>
</dl>
<p>In reactive systems events come in <a class="reference external" href="http://barabasi.com/book/bursts">bursts</a>.  They come whenever they come
with no regard for the current state of your statechart.</p>
<p>Suppose you were building a bank machine where the receiving and authorization
stages involved some complex computing.  To interrupt these states to deal with
an inconveniently timed request would be difficult to program.</p>
<p>Instead of coming up with some complicated scheme for shelving our work to
process new requests, we just defer the event, then re-inject the event into
our statechart when it’s timing is more convenient.</p>
<div align="center" class="align-center"><img alt="_images/deferred1.svg" src="_images/deferred1.svg" /></div>
<p>Here is an example of a chart using the deferred event pattern.</p>
<p>To begin with the chart climbs into the idle state.  Upon receiving it’s first
NEW_REQUEST it transitions into the receiving state.  After a second of
processing it transitions into the authorizing state.  After the authorizing
state processes for 2 seconds it transitions back to the idle state.</p>
<p>The reminder pattern occurs when a NEW_REQUEST event is seen while the system
is either in receiving or authorizing.  This NEW_REQUEST event is ignored by
these states and caught by the hook in processing.  The processing state places
this NEW_REQUEST event into the deferred queue then passes the program’s
control back into whichever state was currently active.</p>
<p>The idle state behaves differently, upon entering, it recalls any events that
were placed in the deferred queue.  This effectively transfers them into the
active object working queue and for all intents and purposes the statechart
will think that this event was just posted to it from the outside world.  In
the next RTC the idle state will react to the posted NEW_REQUEST by
transitioning into the receiving state and the cycle will continue.</p>
<p>Now that you have a high level view of how things are working I will talk about
timing.  The receiving and authorizing states are simulating difficultly by
using one shot events.  We are pretending that instead of just waiting around
for a one shot to fire, that instead, something really important is happening
in the background which we do not want to interrupt.</p>
<p>The event bursts, use to interrupt our chart, will be done with the
<code class="docutils literal"><span class="pre">create_bursts</span></code> function seen on the diagram.  All this function does is to
waste a random amount of time between a few NEW_REQUEST events so that we can
see how are chart reacts.</p>
<p>We will use both the trace and spy instrumentation to look at our timing.  The
trace outputs timing information for state transitions.  So we will use the
trace to see if our chart state transitions remains steady despite the chaos we
are sending at it.  To confirm that we aren’t just fooling ourselves we will
use the spy and scribble when timed events hit the chart.</p>
<p>Now let’s redraw the diagram and then write it’s code:</p>
<div align="center" class="align-center"><img alt="_images/deferred1.svg" src="_images/deferred1.svg" /></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">processing_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;deferred at {}&quot;</span><span class="o">.</span> \
</span><span class="hll">      <span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%M:%S:</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)))</span>
</span>  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">idle_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;recalled at {}&quot;</span><span class="o">.</span> \
</span><span class="hll">      <span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%M:%S:</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)))</span>
</span>  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">idle_new_request</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">receiving</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">receiving_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;receiving&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">RECEIVED</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">receiving_received</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">authorizing</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">authorizing_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;authorizing&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">authorizing_authorized</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;deferred&#39;</span><span class="p">)</span>

<span class="n">processing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">NEW_REQUEST</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_entry</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_init</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">to_method</span><span class="p">()</span>

<span class="n">idle</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;idle&#39;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">idle_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">NEW_REQUEST</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">idle_new_request</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="n">receiving</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;receiving&#39;</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">receiving_entry</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">RECEIVED</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">receiving_received</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">to_method</span><span class="p">()</span>

<span class="n">authorizing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;authorizing&#39;</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
                    <span class="n">handler</span><span class="o">=</span><span class="n">authorizing_entry</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
                    <span class="n">handler</span><span class="o">=</span><span class="n">authorizing_authorized</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">processing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">idle</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">receiving</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">authorizing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">burst_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">bursts</span><span class="p">,</span> <span class="n">fastest_time</span><span class="p">,</span> <span class="n">slowest_time</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="nb">range</span><span class="p">(</span><span class="n">bursts</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">fastest_time</span><span class="p">,</span><span class="n">slowest_time</span><span class="p">))</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

<span class="n">burst_event</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">NEW_REQUEST</span><span class="p">),</span>
             <span class="n">bursts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
             <span class="n">fastest_time</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
             <span class="n">slowest_time</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>I have highlighted the code that I excluded from the diagram.  It is code that
will put timing information into the spy log.</p>
<p>When we run this test, it could take between 7 and 11 seconds.  The trace
and spy results I get will be different from what you get because of the
stochastic characteristics of when the events are posted to the statechart.</p>
<p>Let’s first look at the trace output and confirm that our statechart behaves as
we intended:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">49.465806</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">50.435495</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">51.451824</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.458799</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.459805</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">54.461726</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.463891</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.464915</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">57.466761</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">59.468877</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">59.469876</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
</pre></div>
</div>
<p>The received state takes about 1 second to complete, so we are expecting to see
that the time between a NEW_REQUEST and a RECEIVED event should be about 1
second.  From inspection on lines 2-3, 5-6, 8-9 we see this is true:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">50.435495</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">51.451824</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.459805</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">54.461726</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.464915</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">57.466761</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</td></tr></table></div>
<p>The authorizing state takes about 2 seconds to complete so the RECEIVED and
COMPLETED events should be about 2 seconds apart.  From the inspection of lines
3-4, 6-7 and 9-10 we see this is true.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">.</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">51.451824</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.458799</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">54.461726</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.463891</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">57.466761</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">59.468877</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="o">.</span>
</pre></div>
</td></tr></table></div>
<p>The deferred event pattern states that we will react to the recalled events
immediately and we can see this behavior on lines 4-5 and 8-9</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.458799</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.459805</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.463891</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.464915</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</td></tr></table></div>
<p>Now we have to confirm that NEW_REQUEST events were sent at random times and
deferred by the chart.  To do this we will have to dig into the spy log.  To
make it easier to see I will put spaces after the RTC event and I will
highlight the moments when a NEW_REQUEST was seen and defered by the
chart:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;recalled at 20:49:465806&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;NEW_REQUEST:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:NEW_REQUEST&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;deferred at 20:51:020281&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;NEW_REQUEST:processing:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(1)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;RECEIVED:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(1)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;NEW_REQUEST:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:NEW_REQUEST&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;deferred at 20:51:664940&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;NEW_REQUEST:processing:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(2)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;NEW_REQUEST:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:NEW_REQUEST&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;deferred at 20:52:219593&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;NEW_REQUEST:processing:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(3)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;NEW_REQUEST:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:NEW_REQUEST&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;deferred at 20:53:219562&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;NEW_REQUEST:processing:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(4)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;COMPLETED:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;RECALL:NEW_REQUEST&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:NEW_REQUEST&#39;</span><span class="p">,</span>
 <span class="s1">&#39;recalled at 20:53:459805&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(1) Deferred:(3)&#39;</span><span class="p">,</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
 <span class="s1">&#39;INIT_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(9)&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>From the highlighted time stamps we see that these event injections were
sporatic; so it is safe to assume the design worked.</p>
<p>It turns out the design is a lot easier to explain and write than it is to
verify.  You might be wondering what happens if more items are posted than
there are slots in the deferred queue.  The deferred queue is a <code class="docutils literal"><span class="pre">deque</span></code>, which
means it is a kind of ring buffer.  It you overflow it, it will remove the
oldest item and push the newest item onto the tail end of the queue.  It has a
queue size of 500.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The spy log does not contain timing information.  To add timing information to the
spy only takes a little effort; use the scribble method with a
<code class="docutils literal"><span class="pre">datetime.now()</span></code> call.</p>
</div>
</div>
<div class="section" id="orthogonal-component">
<span id="patterns-orthogonal-component"></span><h2>Orthogonal Component<a class="headerlink" href="#orthogonal-component" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Formal description:</dt>
<dd>“Use state machines as components.”</dd>
</dl>
<p>In the original statechart paper written by David Harel he describes how his
formalism needs to capture requirements like “[The] gearbox change of state is
independent of [the] braking system”.  For this he invented something called a
‘orthogonal region’:</p>
<div align="center" class="align-center"><img alt="_images/orthogonal_region1.svg" src="_images/orthogonal_region1.svg" /></div>
<p>The two different areas in the above chart separated by the dotted line are
orthogonal regions.  They represent two separate state machines that act
independent of one another but are both turned on when the truck state is
initiated.</p>
<p>This part of the Harel formalism is not supported by the Miro Samek event
processing algorithm.  But, it would be trivial to implement within the miros
library, by building two separate active objects and letting them run
independently.</p>
<p>If you would like such a structure in your machine, you could use an orthogonal
component instead.  An orthogonal component is just a statechart that can
dispatch messages directly into another one.</p>
<p>Imagine we are asked to build some software for the general fusion reactor:</p>
<blockquote>
<div>“The General Fusion’s Magnetized Target Fusion system uses a sphere filled
with molten lead-lithium that is pumped to form a vortex.  A pulse of
magnetically-confined plasma fuel is then injected into the vortex. Around
the sphere, an array of pistons drive a pressure wave into the centre of
the sphere, compressing the plasma to fusion conditions. This process is
then repeated, while the heat from the reaction is captured in the liquid
metal and used to generate electricity via a steam turbine.”</div></blockquote>
<p>Ambitious.  Ok, let’s say we have to write the firing mechanism to cause all of
the pistons to initiate the pressure wave.</p>
<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/zf8QIJ2VgqU" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>
</center><p>Each piston has a set of transducers to measure the local conditions of the
molten lead-lithium.  The first transducer provides a composite reading that
abstracts away a lot of the physics; it provides numbers between 0 and 100.
The second transducer measures the temperature; it’s range is 0 to 9000 degrees
Celsius.  A piston can only fire after 1 second has passed since the last
firing event and once it passes this time threshold it would like to fire as
soon as possible so that the fusion reactor can output the maximum amount of
power.</p>
<p>There are 255 pistons.</p>
<p>Through a lot of trial and error it has been found a piston can fire in the
following situations:</p>
<table border="1" class="docutils">
<colgroup>
<col width="41%" />
<col width="59%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Composite Transducer Reading</th>
<th class="head">Temperature Transducer  [degrees Celsius]</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0-20</td>
<td>50-100</td>
</tr>
<tr class="row-odd"><td>25-50</td>
<td>200-333</td>
</tr>
<tr class="row-even"><td>30-66</td>
<td>403-600</td>
</tr>
<tr class="row-odd"><td>70-100</td>
<td>670-1500</td>
</tr>
</tbody>
</table>
<p>All of the pistons have to fire at the same time and they can only fire if the
above criteria are met.</p>
<p>Let’s design the system.  First we will need to fake-out the temperature and
composite transducer readings.  This can be done with an infinite impulse
response filter and a random number generator using a flat distribution.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>  <span class="k">class</span> <span class="nc">FakeNewsSpec</span><span class="p">:</span>
  <span class="sd">&#39;&#39;&#39; provides the following syntax:</span>
<span class="sd">      spec.initial_value</span>
<span class="sd">      spec.aggression</span>
<span class="sd">      spec.minimum</span>
<span class="sd">      spec.maximum</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">aggression</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">initial_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">minimum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">maximum</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">minimum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maximum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">minimum</span> <span class="o">&gt;=</span> <span class="n">maximum</span><span class="p">:</span>
      <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">initial_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximum</span> <span class="o">-</span> <span class="n">minimum</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">elif</span> <span class="n">initial_value</span> <span class="o">&lt;</span> <span class="n">minimum</span><span class="p">:</span>
      <span class="n">initial_value</span> <span class="o">=</span> <span class="n">minimum</span>
    <span class="k">elif</span> <span class="n">initial_value</span> <span class="o">&gt;</span> <span class="n">maximum</span><span class="p">:</span>
      <span class="n">initial_value</span> <span class="o">=</span> <span class="n">maximum</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span> <span class="o">=</span> <span class="n">initial_value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aggression</span>    <span class="o">=</span> <span class="n">aggression</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="n">minimum</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="n">maximum</span>


<span class="k">def</span> <span class="nf">fake_news</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # aggression ranges from 1 to 100.  1 is the least aggressive and 100 is</span>
<span class="sd">    # the most agressive</span>
<span class="sd">    fn = fake_news(</span>
<span class="sd">      FakeNewsSpec(minimum=0, maximum=100, initial_value=45, aggression=50))</span>
<span class="sd">    for i in range(5):</span>
<span class="sd">      print(fn())</span>
<span class="sd">    # 70.40052265431565</span>
<span class="sd">    # 98.55643192543394</span>
<span class="sd">    # 63.607687838082626</span>
<span class="sd">    # 96.33858152348765</span>
<span class="sd">    # 47.2780049249278</span>

<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">AGGRESSION_MAX</span> <span class="o">=</span> <span class="mi">100</span>
  <span class="sd">&#39;&#39;&#39;returns a function that will generate the kind of fake news specified&#39;&#39;&#39;</span>
  <span class="kn">import</span> <span class="nn">random</span>
  <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

  <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">spec</span><span class="o">.</span><span class="n">aggression</span> <span class="o">&lt;=</span> <span class="n">AGGRESSION_MAX</span><span class="p">:</span>
    <span class="n">aggression</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">aggression</span>
  <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">aggression</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">aggression</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">aggression</span> <span class="o">=</span> <span class="n">AGGRESSION_MAX</span>

  <span class="k">def</span> <span class="nf">_fake_news_generator</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;provides an infinite set of number within the spec&#39;&#39;&#39;</span>
    <span class="n">current_number</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">initial_value</span>

    <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
      <span class="n">random_number</span>  <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">maximum</span><span class="p">)</span>
      <span class="c1"># IIR (infinite impulse response)</span>
      <span class="n">current_number</span> <span class="o">=</span> <span class="p">((</span><span class="n">aggression</span> <span class="o">*</span> <span class="n">random_number</span> <span class="o">+</span>
                         <span class="p">(</span><span class="n">AGGRESSION_MAX</span> <span class="o">-</span> <span class="n">aggression</span><span class="p">)</span> <span class="o">*</span>
                         <span class="n">current_number</span><span class="p">))</span> <span class="o">/</span> <span class="n">AGGRESSION_MAX</span>
      <span class="k">yield</span> <span class="n">current_number</span>

  <span class="k">def</span> <span class="nf">_fake_news</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;just hides the next syntax&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">_fake_news_generator</span><span class="p">())</span>

  <span class="k">return</span> <span class="n">_fake_news</span>
</pre></div>
</div>
<p>Ok, let’s try it out:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">transducer_worker</span> <span class="o">=</span> <span class="n">fake_news</span><span class="p">(</span>
                      <span class="n">FakeNewsSpec</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                   <span class="n">initial_value</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">aggression</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="n">transducer_worker</span><span class="p">())</span>
<span class="c1"># 39.41035307935898</span>
<span class="c1"># 51.639646042274904</span>
<span class="c1"># 53.30613755950629</span>
</pre></div>
</div>
<p>We see we can make the numbers swing around, it’s turnable.  Good enough,
pushing on.</p>
<p><a class="reference external" href="https://www.ted.com/talks/michel_laberge_how_synchronized_hammer_strikes_could_generate_nuclear_fusion">Michel Laberge</a> would propably change his mind about a piston’s firing
criteria, so we have to make sure it’s easy to change.  We will create a
is-this-piston-ready function then we can inject it into our design.  For now
we define it as this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_this_piston_ready</span><span class="p">(</span><span class="n">piston</span><span class="p">):</span>
  <span class="n">comp</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">get_composite_reading</span><span class="p">()</span>
  <span class="n">temp</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">get_temperature_reading</span><span class="p">()</span>

  <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">20</span> <span class="ow">and</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="mi">25</span> <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">50</span> <span class="ow">and</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">333</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="mi">30</span> <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">66</span> <span class="ow">and</span> <span class="mi">403</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">600</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="mi">70</span> <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="ow">and</span> <span class="mi">670</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">1500</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="k">return</span> <span class="n">ready</span>
</pre></div>
</div>
<p>Here is the high level UML class diagram for our approach:</p>
<div align="center" class="align-center"><img alt="_images/orthogonal_region3.svg" src="_images/orthogonal_region3.svg" /></div>
<p>The FusionReactor class will be a subclass of the Factory.  It will aggregate
255 object of the Piston class.  The FusionReactor object will connect to the
reactor_on state machine and each of the piston objects will use the same
piston_active state machine.  It is not show on the</p>
<p>The PistonManager objects will each contain their own event dispatchers, their
own event queues; but they will all reference the same piston_manager state
machine.</p>
<p>We are going to use the polyamorous nature of state methods to implement the
255 piston managers.  Instead of having a separate piston manager statemachine
defined for each of the 255 active objects we will instead define one that is
shared by all of them.  I will link to it once per each active object and they
won’t know that they don’t contain them as methods within their own class.  I
have no idea how to represent this in UML.  So I will write it this way:</p>
<div align="center" class="align-center"><img alt="_images/orthogonal_region4.svg" src="_images/orthogonal_region4.svg" /></div>
<p>The state machine will be defined as:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">piston_ready</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">relaxing</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">piston</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">750</span><span class="p">:</span>
      <span class="n">piston</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">piston</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PRIMED</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">top</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">relaxing</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;relaxing&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston_ready</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">triggered</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;piston_slamming!&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston_ready</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">priming</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span> <span class="n">piston</span><span class="o">.</span><span class="n">is_this_piston_ready</span><span class="p">():</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston_ready</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">FIRE</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">triggered</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">priming</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div></blockquote>
<p>Now we will create the PistonManager class:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PistonManager</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">get_composite_reading</span><span class="p">,</span>
               <span class="n">get_temperature_reading</span><span class="p">,</span>
               <span class="n">is_this_piston_ready</span><span class="p">,</span>
               <span class="n">number</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_this_piston_ready</span>    <span class="o">=</span> <span class="n">is_this_piston_ready</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_composite_reading</span>   <span class="o">=</span> <span class="n">get_composite_reading</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_temperature_reading</span> <span class="o">=</span> <span class="n">get_temperature_reading</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">composite</span>
</pre></div>
</div>
</div></blockquote>
<p>To keep things flexible we will write a <code class="docutils literal"><span class="pre">build_piston</span></code> function which we can
change once we have read data coming in from the fusion reactor:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_piston</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">starting_state</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  The place to change how a fusion piston is constructed, set:</span>
<span class="sd">    get_composite_reading (where composite data is aquired)</span>
<span class="sd">    get_temperature_reading (where temperature data is aquired)</span>
<span class="sd">    is_this_piston_ready (to determine if it is ready to go)</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">piston</span> <span class="o">=</span> <span class="n">PistonManager</span><span class="p">(</span>
    <span class="n">get_composite_reading</span><span class="o">=</span><span class="n">fake_news</span><span class="p">(</span>
      <span class="n">FakeNewsSpec</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">maximum</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                   <span class="n">initial_value</span><span class="o">=</span><span class="mi">89</span><span class="p">,</span>
                   <span class="n">aggression</span><span class="o">=</span><span class="mi">21</span><span class="p">)),</span>
    <span class="n">get_temperature_reading</span><span class="o">=</span><span class="n">fake_news</span><span class="p">(</span>
      <span class="n">FakeNewsSpec</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">maximum</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
                   <span class="n">initial_value</span><span class="o">=</span><span class="mi">798</span><span class="p">,</span>
                   <span class="n">aggression</span><span class="o">=</span><span class="mi">16</span><span class="p">)),</span>
    <span class="n">is_this_piston_ready</span><span class="o">=</span><span class="n">is_this_piston_ready</span><span class="p">,</span>
    <span class="n">number</span><span class="o">=</span><span class="n">number</span>
  <span class="p">)</span>
  <span class="n">piston</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">starting_state</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">piston</span>
</pre></div>
</div>
<p>Now I will add the fire manager:</p>
<div align="center" class="align-center"><img alt="_images/orthogonal_region5.svg" src="_images/orthogonal_region5.svg" /></div>
<p>To construct the invidual</p>
</div>
<div class="section" id="transition-to-history">
<span id="patterns-transition-to-history"></span><h2>Transition To History<a class="headerlink" href="#transition-to-history" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="multichart-race">
<span id="patterns-multichart-race"></span><h2>Multichart Race<a class="headerlink" href="#multichart-race" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="multichart-pend">
<span id="patterns-multichart-pend"></span><h2>Multichart Pend<a class="headerlink" href="#multichart-pend" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[4]</a></td><td>p.206 Practical UML STATECHARTS in C/C++, Second Edition</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[5]</a></td><td>p.211 Practical UML STATECHARTS in C/C++, Second Edition</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[6]</a></td><td>p.219 Practical UML STATECHARTS in C/C++, Second Edition</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Patterns</a><ul>
<li><a class="reference internal" href="#ultimate-hook">Ultimate Hook</a></li>
<li><a class="reference internal" href="#reminder">Reminder</a></li>
<li><a class="reference internal" href="#deferred-event">Deferred Event</a></li>
<li><a class="reference internal" href="#orthogonal-component">Orthogonal Component</a></li>
<li><a class="reference internal" href="#transition-to-history">Transition To History</a></li>
<li><a class="reference internal" href="#multichart-race">Multichart Race</a></li>
<li><a class="reference internal" href="#multichart-pend">Multichart Pend</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="reflection.html" title="previous chapter">Reflection</a></li>
      <li>Next: <a href="testing.html" title="next chapter">Testing</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/patterns.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Scott Volk.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/patterns.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>