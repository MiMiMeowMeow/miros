
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Patterns &#8212; miros 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Reflection" href="reflection.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <table class="hlist"><tr><td><ul class="simple">
<li><a class="reference internal" href="#patterns-ultimate-hook"><span class="std std-ref">ultimate hook</span></a></li>
<li><a class="reference internal" href="#patterns-reminder"><span class="std std-ref">reminder</span></a></li>
<li><a class="reference internal" href="#patterns-deferred-event"><span class="std std-ref">deferred event</span></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="#patterns-orthogonal-component"><span class="std std-ref">orthogonal component</span></a></li>
<li><a class="reference internal" href="#patterns-transition-to-history"><span class="std std-ref">transition to history</span></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="#patterns-multichart-race"><span class="std std-ref">multichart race</span></a></li>
<li><a class="reference internal" href="#patterns-multichart-pend"><span class="std std-ref">multichart pend</span></a></li>
</ul>
</td></tr></table>
<div class="section" id="id1">
<h1>Patterns<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>The idea of software design patterns came from the architect Christopher
Alexander.  He wrote a book, a pattern language, about how different approaches
to architecture could be used across different scales (from the country to the
pantry) to help people feel better about living in their communities.  It’s a
lovely book; a child can understand it yet it is still useful to professional
architects.</p>
<p>This can not be said for the book it inspired in computer science, “Design
Patterns: Elements of Reusable Object-Oriented Software”  This book <em>was not</em>
child friendly, in fact everyone I knew secretly hated it because of its
illegibility; but would make sure to have a copy of it on their shelf to look
like they were in the club.</p>
<p>The ideas within the book were great and the follow up books that translated it
into English were really useful.  Basically it described a set of techniques
for solving classes of problems that come up over and over again.  If you
haven’t learned the patterns yet, find a copy of a patterns book written by a
practitioner in your language(s) and work through it.  You will level up.</p>
<p>In chapter 5 of “Practical UML STATECHARTS in C/C++” I was leveled up by Miro
Samek.  He describes 5 statechart patterns and made the bold claim that
<strong>statecharts are a pattern of patterns</strong>.  I completely agree with him.  So here
is my translation of his work into this library.  I’ll start each pattern with
quotes from his book, then write about it within the context of this work.</p>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="ultimate-hook">
<span id="patterns-ultimate-hook"></span><h2>Ultimate Hook<a class="headerlink" href="#ultimate-hook" title="Permalink to this headline">¶</a></h2>
<p>Formal description:</p>
<blockquote>
<div><p>[The Ultimate Hook Pattern provides a] common facilities and policies for
handling events but let clients override and specialize every aspect of the
system’s behavior.</p>
<p>The semantics of state nesting provide the desired mechanism of handling
all events, first in the context of the client code (the nested state) and
of automatically forwarding of all unhandled events to the [parent state]
(the default behavior). In that way, the client code intercepts every
stimulus and can override every aspect of the behavior. To reuse the
default behavior, the client simply ignores the event and lets the
superstate handle it (the [child state] inherits behavior from the
superstate) <a class="footnote-reference" href="#id4" id="id2">[3]</a></p>
</div></blockquote>
<p>Makes sense to me.  Keep up! ;)</p>
<p>To understand the ultimate hook pattern, you first have to understand what a
hook is.  It is just some code in an <code class="docutils literal"><span class="pre">if-elif</span></code> clause.   A hook is just some
code that catches an event, runs your <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> and then
returns something which tells the event processor to stop searching.  <strong>A hook
doesn’t cause a state transition</strong>.  It is a way to get the event processor’s
search algorithm to do work for you without changing state.</p>
<p>You see, anytime the event processor is trying to figure out what to do with an
event it needs to <a class="reference internal" href="recipes.html#recipes-what-a-state-does-and-how-to-structure-it"><span class="std std-ref">search your
statechart</span></a>.  If it finds
that it needs to do a transition, it will enlist the heavy-duty parts of it’s
algorithm to make sure that the <a class="reference internal" href="glossary.html#term-harel-formalism"><span class="xref std std-term">Harel Formalism</span></a>
occurs.  The hook has nothing to do with this, because it short circuits the
search before it does a transition, but not before it gets this search algorithm
to do some useful work.</p>
<p>If your if-else structure in your state method catches the signal name of an
event, runs your code, then returns the <code class="docutils literal"><span class="pre">return_status.HANDLED</span></code> back to the
event processor, no state transition will occur.  This is how you make a hook.
You make sure that part of your if-elif clause catches the event signal, runs
your <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> and returns the <code class="docutils literal"><span class="pre">return_state.HANDLED</span></code>
value.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook1.svg" src="_images/ultimate_hook1.svg" /></div>
<p>Here is a simple example which demonstrates a hook.  In this example we will
show that we can get some client code to run when we post an event with the
signal name of BEHAVIOR_NAME to your statechart:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">spy_on</span><span class="p">,</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># your code would go here</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your outer_state code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>The highlighted code describes the hook.  We see that when the BEHAVIOR_NAME
signal is caught by this state method it runs your <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> then returns <code class="docutils literal"><span class="pre">return_status.HANDLED</span></code>.</p>
<p>The <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> output would look like this:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BEHAVIOR_NAME:outer_state&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;your outer_state code here&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;BEHAVIOR_NAME:outer_state:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Lines 1-5 describe the first <a class="reference internal" href="glossary.html#term-run-to-completion"><span class="xref std std-term">rtc</span></a> event which occurs
when we start the statechart.  Lines 5-9 of the
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log actually describe the hook behavior.  The
event processor ran, searching the statechart starting at the outer_state
method to see if it knew how to process the BEHAVIOR_NAME signal and it did:
the <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> just
<a class="reference internal" href="recipes.html#recipes-scribble-on-the-spy"><span class="std std-ref">scribbled</span></a> something into our
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log so we can see what happened.  On line 7
we see the result of this in the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log.
Furthermore, no state transition occurred.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook2.svg" src="_images/ultimate_hook2.svg" /></div>
<p>Now suppose we add another state within the outer state and start our active
object there.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">spy_on</span><span class="p">,</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>


<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
    <span class="c1"># your code would go here</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your outer_state code here&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="hll"><span class="nd">@spy_on</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># your code would go here</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your inner_state code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">outer_state</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="hll"><span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
</span><span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>Then look at the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BEHAVIOR_NAME:inner_state&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;your inner_state code here&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;BEHAVIOR_NAME:inner_state:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Ok, no surprises.  The inner_state hooked the BEHAVIOR_NAME signal and
ran some <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a>.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook3.svg" src="_images/ultimate_hook3.svg" /></div>
<p>Now let’s remove the handling of the BEHAVIOR_NAME from our
inner state and see what happens when we start the active object in the
inner_state then send it an event with the BEHAVIOR_NAME.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">spy_on</span><span class="p">,</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
    <span class="c1"># your code would go here</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your outer_state code here&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="c1">#if(e.signal == signals.BEHAVIOR_NAME):</span>
  <span class="c1">#  # your code would go here</span>
  <span class="c1">#  chart.scribble(&quot;your inner_state code here&quot;)</span>
  <span class="c1">#  status = return_status.HANDLED</span>
  <span class="c1">#else:</span>
  <span class="c1">#  chart.temp.fun = outer_state</span>
  <span class="c1">#  status = return_status.SUPER</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>

<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>In the highlighted code you can see that I adjusted the inner_state to run as
if it’s <code class="docutils literal"><span class="pre">else</span></code> method clause was always active.  I did this so that it would not
handle the BEHAVIOR_NAME signal.  Now we run the code and look at the
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> output.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;BEHAVIOR_NAME:inner_state&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;BEHAVIOR_NAME:outer_state&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;your outer_state code here&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;BEHAVIOR_NAME:outer_state:HOOK&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>The highlighted lines show how our event processor tried to determine what to
do with the event containing the BEHAVIOR_NAME signal.</p>
<p>It called the inner_state with the event (8), it wasn’t handled, so it
called the parent outer_state with the same event (9) and we see on
line (10) that the outer_state <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> was run.  Finally, on line (11)
the spy instrumentation tells us that it detected a hooked event.  When you see
this in the log it means there was no state transition.</p>
<p>So, the outer_state hook code caught an event that was sent to the
inner_state.  The <a class="reference internal" href="glossary.html#term-harel-formalism"><span class="xref std std-term">Harel Formalism</span></a> followed by the
event processor determines that when it has an event, it will search outward
from the current state, to the next <a class="reference internal" href="glossary.html#term-parent-state"><span class="xref std std-term">parent state</span></a>, then the next parent state
over and over until your event is handled or, it reaches the top most state of
your <a class="reference internal" href="glossary.html#term-hierarchical-state-machine"><span class="xref std std-term">HSM</span></a>. This means that any inner state
method will automatically inherit the hook code of any outer state.  The outer
most state contains the ultimate hook; this is why the pattern is called what
it is.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook4.svg" src="_images/ultimate_hook4.svg" /></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To show that there is some sort of explicit design feature occuring on your
diagram, something that might be too subtle for someone to see right away UML
provides a dotted-collaboration-bubble.  It is very easy to over use
this feature and clutter up your diagram.</p>
</div>
<p>You can overwrite the behavior of the outer state hooks simply by explicitly
handling the signal in an inner state.  These ideas are very similar to
inheritance and overloading in object oriented programming.</p>
<p>As a designer you would write default <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> behavior in the outer states
of charts, and all of your inner states would get this behavior for free.  If
they needed to overwrite this behavior they would specifically handle the
event in their state methods.</p>
<div align="center" class="align-center"><img alt="_images/ultimate_hook5.svg" src="_images/ultimate_hook5.svg" /></div>
<p>You would place generic reactions to events in your outer states and place the
specific responses in your inner states. Let’s build out the above diagram:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="hll"><span class="k">def</span> <span class="nf">process_a_generic</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s1">&#39;processing a generic&#39;</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="hll"><span class="k">def</span> <span class="nf">process_b_generic</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s1">&#39;processing b generic&#39;</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="hll"><span class="c1"># overrides the generic hook while in the specific state</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">process_a_specific</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s1">&#39;processing a specific&#39;</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;ultimate_hook_example&#39;</span><span class="p">)</span>
<span class="n">generic</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;generic&#39;</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">process_a_generic</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">process_b_generic</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">to_method</span><span class="p">()</span>

<span class="n">specific</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;specific&#39;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">process_a_specific</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">generic</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">specific</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">specific</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>First of all we notice that instead of using an active object the diagram asks
us to use a <a class="reference internal" href="towardsthefactoryexample.html#towardsthefactoryexample-using-the-factory-class"><span class="std std-ref">factory</span></a>.
To use the factory we create states and tie specific signals to callback
functions.</p>
<p>The highlighted code shows the callback functions that are acting like hooks.
Pay special attention to what they return.  If they do not return
<code class="docutils literal"><span class="pre">return_status.HANDLED</span></code> they will not work as hooks.</p>
<p>We can deterime if we got the expected behavior by looking at the
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:generic&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:generic&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;b:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;b:generic&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;processing b generic&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;b:generic:HOOK&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;a:specific&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;processing a specific&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;a:specific:HOOK&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>On lines 10 and 11 we see the reaction to our first <code class="docutils literal"><span class="pre">b</span></code> signal.  As expected
the generic state’s hook function was run while the statechart remained in the
specific state.</p>
<p>On lines 14 and 15 we see the specific behavior for the <code class="docutils literal"><span class="pre">a</span></code> signal.  The
statechart ran the <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> in the specific state then
stopped processing the signal.</p>
</div>
<div class="section" id="reminder">
<span id="patterns-reminder"></span><h2>Reminder<a class="headerlink" href="#reminder" title="Permalink to this headline">¶</a></h2>
<p>Formal description:</p>
<blockquote>
<div><p>Make the statechart topology more flexible by inventing an event an posting
it  to itself.</p>
<p>Often in state modeling, loosely related functions of a system are strongly
coupled by a common event. Consider, for example, periodic data acquisition,
in which a sensor producing the data needs to be polled at a predetermined
rate. Assume that a periodic TIME_OUT event is dispatched to the system at
the desired rate to provide the stimulus for polling the sensor. Because the
system has only one external event (the TIME_OUT event), it seems that this
event needs to trigger both the polling of the sensor and the processing of
the data. A straightforward but suboptimal solution is to organize the state
machine into two distinct orthogonal regions (for polling and processing).
However, orthogonal regions increase the cost of dispatching events … and
require complex synchronization between the regions because the polling and
processing are not quite independent. <a class="footnote-reference" href="#id5" id="id3">[4]</a></p>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Programming a statechart with <a class="reference internal" href="glossary.html#term-orthogonal-region"><span class="xref std std-term">orthogonal regions</span></a> is
computationally expensive.  So if you find yourself drawing two seperate states
with a lot of arrows connecting them, remind yourself of the reminder pattern.</p>
</div>
<p>The reminder pattern uses the ultimate hook pattern mixed with
<a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial event</span></a> injection.  It’s an artificial event
because it is invented by the statechart and injected to itself rather than
being invented and injected by an outside caller.</p>
<p>I’ll try to explain this idea by showing a design using orthogonal regions,
show how it is expensive and then refactor the design using the reminder
pattern.</p>
<p>We will begin with some specifications:</p>
<ul class="simple">
<li>Part of the system will poll a sensor based on a system clock running with
a period of 100ms.</li>
<li>Once polled this information will be sent to some processing code.</li>
<li>After five such events, the system will perform some processing and it will
enter a busy state (maybe communicating with a server).</li>
<li>While the unit is in a busy state it should not poll the sensor or process
input.</li>
<li>After the busy process is completed the system should go back into it’s
polling mode.</li>
</ul>
<p>Here is a first shot at implementing this specification:</p>
<div align="center" class="align-center"><img alt="_images/reminder1.svg" src="_images/reminder1.svg" /></div>
<p>We create a polling state which upon entry poles something.  Any time there is
a time out it will re-enter the state making this happen.</p>
<p>Then when it Initializes it transitions into the processing state.  Upon
entering the processing state we add one to the <code class="docutils literal"><span class="pre">chart.processing_count</span></code> and
then process the message.  When the processing state initializes itself it will
either go back to the polling state or enter the busy state, if the
<code class="docutils literal"><span class="pre">chart.processing_count</span></code> is high enough.</p>
<p>Upon entering the busy state the <code class="docutils literal"><span class="pre">chart.busy_count</span></code> is set to zero.  Then the
TIME_OUT event is used with a <span class="xref std std-term">hook</span> to work the information.  In
this example we just scribble “busy” into the spy log.  Then we add 1 to our
<code class="docutils literal"><span class="pre">chart.busy_count</span></code>.  If the count is big enough we transition back to the
polling state.  Upon exiting the processing state, the
<code class="docutils literal"><span class="pre">chart.processing_count</span></code> is set to 0.  That should work!</p>
<p>But notice the large <strong>Xs</strong> on the diagram.  These are there to show that they
are illegal transitions.  The Miro Samek event processoring algorithm will only
allow init events to drill further into child states; they can not leave there
current state and navigate to another region of the chart.   It’s an honest
mistake.</p>
<p>Let’s see what happens when we try to make this broken statechart</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">polling_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">polling_enter</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span>
<span class="hll">  <span class="k">return</span> <span class="n">return_state</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">
</span><span class="k">def</span> <span class="nf">polling_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="c1"># illegal (init can&#39;t leave parent states)</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">processing_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span>
</span><span class="hll">  <span class="k">else</span><span class="p">:</span>
</span>  <span class="c1"># illegal (init can&#39;t leave parent states)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">processing_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;reminder_pattern_needed_1&#39;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;processing_count&quot;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;busy_count&quot;</span><span class="p">)</span>

<span class="n">polling</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_time_out</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">processing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_entry</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_exit</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">busy</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_time_out</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">polling</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">processing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">busy</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">),</span> <span class="n">times</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>I have highlighted the illegal transition.</p>
<p>If we run the code we will see:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">miros</span><span class="o">.</span><span class="n">hsm</span><span class="o">.</span><span class="n">HsmTopologyException</span><span class="p">:</span>
  <span class="n">impossible</span> <span class="n">chart</span> <span class="n">topology</span> <span class="k">for</span> <span class="n">HsmEventProcessor</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
  <span class="n">see</span> <span class="n">HsmEventProcessor</span><span class="o">.</span><span class="n">init</span> <span class="n">doc</span> <span class="n">string</span> <span class="k">for</span> <span class="n">details</span>
</pre></div>
</div>
<p>So, how do we make this software work?  When you see this
<code class="docutils literal"><span class="pre">HsmTopologyException</span></code>, it’s probably time to consider another way to design
your statechart.  We will get to that shortly, but for now let’s find a way to force
this software to work they way we want it too.</p>
<p>Instead of making the INIT_SIGNAL transition outside of the state, instead we
could invent a new signal, post it to ourselves and pretend like it came from
outside of the active object and then react to it like we would any other
event.  This is why it is called an <a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial event</span></a>.</p>
</div>
<div class="section" id="deferred-event">
<span id="patterns-deferred-event"></span><h2>Deferred Event<a class="headerlink" href="#deferred-event" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="orthogonal-component">
<span id="patterns-orthogonal-component"></span><h2>Orthogonal Component<a class="headerlink" href="#orthogonal-component" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="transition-to-history">
<span id="patterns-transition-to-history"></span><h2>Transition To History<a class="headerlink" href="#transition-to-history" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="multichart-race">
<span id="patterns-multichart-race"></span><h2>Multichart Race<a class="headerlink" href="#multichart-race" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="multichart-pend">
<span id="patterns-multichart-pend"></span><h2>Multichart Pend<a class="headerlink" href="#multichart-pend" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[3]</a></td><td>p.206 Practical UML STATECHARTS in C/C++, Second Edition</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[4]</a></td><td>p.211 Practical UML STATECHARTS in C/C++, Second Edition</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Patterns</a><ul>
<li><a class="reference internal" href="#ultimate-hook">Ultimate Hook</a></li>
<li><a class="reference internal" href="#reminder">Reminder</a></li>
<li><a class="reference internal" href="#deferred-event">Deferred Event</a></li>
<li><a class="reference internal" href="#orthogonal-component">Orthogonal Component</a></li>
<li><a class="reference internal" href="#transition-to-history">Transition To History</a></li>
<li><a class="reference internal" href="#multichart-race">Multichart Race</a></li>
<li><a class="reference internal" href="#multichart-pend">Multichart Pend</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="reflection.html" title="previous chapter">Reflection</a></li>
      <li>Next: <a href="testing.html" title="next chapter">Testing</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/patterns.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Scott Volk.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/patterns.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>